{% macro settings_button() -%}
<button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#settingsModal" title="Настройки">
  <i class="bi bi-gear"></i>
</button>
{%- endmacro %}

{% macro settings_modal(app_version, show_archive=False, archive_target='') -%}
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel">
          <i class="bi bi-gear me-2"></i>Настройки
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center gap-3">
          <span class="fw-semibold">Смена режима</span>
          <button class="btn btn-outline-secondary" id="themeToggleBtn" type="button" title="Тема">
            <i class="bi bi-sun"></i>
            <span class="ms-2" data-theme-toggle-label>Светлая</span>
          </button>
        </div>

        {% if show_archive %}
        <div class="d-flex justify-content-between align-items-center gap-3 mt-3">
          <span class="fw-semibold">Архив</span>
          <button
            class="btn btn-outline-secondary"
            type="button"
            data-settings-open-archive="1"
            data-archive-target="{{ archive_target if archive_target else '#archiveModal' }}"
          >
            <i class="bi bi-archive me-1"></i> Открыть
          </button>
        </div>
        {% endif %}

        <hr class="my-3">

        <div class="small text-muted">
          <div class="mb-2">
            <span class="fw-semibold text-body-emphasis">Версия приложения:</span>
            <span>{{ app_version }}</span>
          </div>
          <div class="mb-2">
            <span class="fw-semibold text-body-emphasis">Репозиторий проекта:</span>
            <a href="https://github.com/KEV0143/Education-Rating-System" target="_blank" rel="noopener noreferrer">
              github.com/KEV0143/Education-Rating-System
            </a>
          </div>
          <div class="mb-2">
            Программный комплекс разработан студентом кафедры прикладной математики
            РТУ МИРЭА Климкиным Егором Владимировичем.
          </div>
          <div class="mb-0">
            При обнаружении ошибок или наличии предложений по развитию проекта,
            пожалуйста, свяжитесь через Telegram:
            <a href="https://t.me/klimkinev" target="_blank" rel="noopener noreferrer">@klimkinev</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function (window, document) {
    function updateThemeToggleButton() {
      const btn = document.getElementById('themeToggleBtn');
      if (!btn) return;

      const theme = document.documentElement.getAttribute('data-bs-theme') || 'light';
      const icon = btn.querySelector('i');
      const label = btn.querySelector('[data-theme-toggle-label]');
      if (!icon) return;

      if (theme === 'dark') {
        icon.className = 'bi bi-moon-stars';
        btn.title = 'Тёмная тема';
        if (label) label.textContent = 'Тёмная';
      } else {
        icon.className = 'bi bi-sun';
        btn.title = 'Светлая тема';
        if (label) label.textContent = 'Светлая';
      }
    }

    function toggleTheme() {
      const cur = document.documentElement.getAttribute('data-bs-theme') || 'light';
      const next = (cur === 'dark') ? 'light' : 'dark';
      document.documentElement.setAttribute('data-bs-theme', next);
      localStorage.setItem('rs-theme', next);
      updateThemeToggleButton();
    }

    function initThemeToggle() {
      const btn = document.getElementById('themeToggleBtn');
      if (!btn) return;

      updateThemeToggleButton();
      if (btn.dataset.themeBound === '1') return;

      btn.dataset.themeBound = '1';
      btn.addEventListener('click', toggleTheme);
    }

    function initArchiveShortcuts() {
      const buttons = document.querySelectorAll('[data-settings-open-archive="1"]');
      if (!buttons.length) return;

      buttons.forEach((btn) => {
        if (btn.dataset.archiveBound === '1') return;
        btn.dataset.archiveBound = '1';

        btn.addEventListener('click', () => {
          if (typeof bootstrap === 'undefined') return;

          const targetSelector = btn.dataset.archiveTarget || '#archiveModal';
          const settingsEl = document.getElementById('settingsModal');
          if (!settingsEl) return;

          const settingsModal =
            bootstrap.Modal.getInstance(settingsEl) || new bootstrap.Modal(settingsEl);
          settingsModal.hide();

          window.setTimeout(() => {
            const archiveEl = document.querySelector(targetSelector);
            if (!archiveEl) return;

            const archiveModal = bootstrap.Modal.getOrCreateInstance
              ? bootstrap.Modal.getOrCreateInstance(archiveEl)
              : (bootstrap.Modal.getInstance(archiveEl) || new bootstrap.Modal(archiveEl));
            archiveModal.show();
          }, 200);
        });
      });
    }

    window.SettingsTheme = {
      initThemeToggle,
      updateThemeToggleButton,
      toggleTheme,
      initArchiveShortcuts,
    };

    document.addEventListener('DOMContentLoaded', () => {
      initThemeToggle();
      initArchiveShortcuts();
    });
  })(window, document);
</script>
{%- endmacro %}
