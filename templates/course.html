<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{{ course.title }} ‚Äî –ö—É—Ä—Å</title>

  <script>
    (() => {
      const saved = localStorage.getItem('rs-theme');
      const theme = (saved === 'dark' || saved === 'light') ? saved : 'light';
      document.documentElement.setAttribute('data-bs-theme', theme);
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <link rel="icon" href="{{ url_for('static', filename='iconkev.ico') }}" type="image/x-icon">
  <link rel="shortcut icon" href="{{ url_for('static', filename='iconkev.ico') }}" type="image/x-icon">

  <style>
    :root{
      --rs-page-bg: #f8f9fa;
      --rs-text: #333;
      --rs-card-bg: #ffffff;
      --rs-border: #eee;
      --rs-soft-border: #dee2e6;
      --rs-img-bg: #f1f3f5;
      --rs-shadow: rgba(0,0,0,0.03);
      --rs-shadow-hover: rgba(0,0,0,0.08);
      --rs-hover-bg: #f1f3f5;
      --rs-muted: #6c757d;
    }
    :root[data-bs-theme="dark"]{
      --rs-page-bg: #0f1216;
      --rs-text: #e9ecef;
      --rs-card-bg: #151a21;
      --rs-border: rgba(255,255,255,0.08);
      --rs-soft-border: rgba(255,255,255,0.14);
      --rs-img-bg: #0e1116;
      --rs-shadow: rgba(0,0,0,0.35);
      --rs-shadow-hover: rgba(0,0,0,0.55);
      --rs-hover-bg: rgba(255,255,255,0.06);
      --rs-muted: rgba(255,255,255,0.65);
    }

    body { background-color: var(--rs-page-bg); color: var(--rs-text); font-family: 'Segoe UI', system-ui, sans-serif; }

    .card-course {
      display: flex;
      background: var(--rs-card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 5px var(--rs-shadow);
      transition: 0.3s;
      margin-bottom: 20px;
      align-items: stretch;
      border: 1px solid var(--rs-border);
      height: 160px;
      overflow: visible;
      position: relative;
    }
    .card-course:hover { box-shadow: 0 8px 20px var(--rs-shadow-hover); transform: translateY(-2px); z-index: 10; }

    .course-img-container {
      width: 240px;
      min-width: 240px;
      background-color: var(--rs-img-bg);
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .course-img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .group-icon-wrap{
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(13,110,253,0.22);
    }
    .group-icon-wrap i{
      font-size: 56px;
      line-height: 1;
    }

    .course-body {
      flex-grow: 1;
      padding: 15px 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    .group-badge {
      font-size: 0.75rem; padding: 4px 8px; border-radius: 6px;
      background: #0d6efd; color: white; text-decoration: none;
      display: inline-block; margin-right: 5px;
    }

    .meta-line{
      font-size: 0.9rem;
      color: var(--rs-muted);
      margin-top: 6px;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }
    .meta-line span i{ margin-right: 6px; }
    .meta-strong{ color: var(--rs-text); font-weight:600; }

    .donut {
      --p: 0;
      --size: 62px;
      --thickness: 10px;
      --c: var(--bs-success);
      --bg: var(--bs-secondary-bg);
      width: var(--size);
      height: var(--size);
      border-radius: 50%;
      background: conic-gradient(var(--c) calc(var(--p) * 1%), var(--bg) 0);
      position: relative;
      flex: 0 0 auto;
      margin: 0 auto;
    }
    .donut::after{
      content: '';
      position: absolute;
      inset: var(--thickness);
      background: var(--rs-card-bg);
      border-radius: 50%;
    }
    .donut-text{
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      line-height: 1;
      color: var(--rs-text);
      z-index: 1;
      user-select: none;
    }

    :root[data-bs-theme="dark"] .bg-light{ background-color: var(--rs-card-bg) !important; }
    :root[data-bs-theme="dark"] .bg-white{ background-color: var(--rs-card-bg) !important; }
    :root[data-bs-theme="dark"] .text-dark{ color: var(--rs-text) !important; }
  </style>
</head>
<body>
{% from "partials/settings.html" import settings_button, settings_modal %}

<div class="container py-5">

  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <a href="/" class="btn btn-outline-secondary btn-sm mb-2">
        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
      </a>
      <h2 class="m-0 fw-bold">{{ course.title }}
        {% if course.archived %}
          <span class="badge bg-secondary ms-2 align-middle">–ê—Ä—Ö–∏–≤</span>
        {% endif %}
      </h2>
      <div class="text-muted small mt-1">
        <i class="bi bi-calendar"></i> {{ course.year }} &nbsp;|&nbsp;
        <i class="bi bi-journal"></i> {{ course.semester }} —Å–µ–º–µ—Å—Ç—Ä
      </div>
    </div>

    <div class="ms-3">
      <div class="d-flex gap-2 flex-wrap justify-content-end">
        {{ settings_button() }}
        <a class="btn btn-primary d-inline-flex align-items-center"
           href="{{ url_for('course_assessments', course_id=course.id) }}">
          <i class="bi bi-clipboard-check me-2"></i>
          <span>–ó–∞–¥–∞–Ω–∏—è –∏ –æ—Ü–µ–Ω–∫–∏</span>
        </a>

        <button class="btn btn-outline-success d-inline-flex align-items-center"
           type="button" data-bs-toggle="modal" data-bs-target="#exportExcelModal">
          <i class="bi bi-file-earmark-excel me-2"></i>
          <span>–í—ã–≥—Ä—É–∑–∫–∞ Excel</span>
        </button>
      </div>
    </div>
  </div>

  <div class="card-course mb-4" style="cursor: default;">
    <div class="course-img-container">
      <img src="{{ url_for('course_image', course_id=course.id) }}" class="course-img" onerror="this.src='/placeholder'">
    </div>

    <div class="course-body">
      <div class="text-muted small mb-2">–ì—Ä—É–ø–ø—ã –∫—É—Ä—Å–∞</div>
      <div style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
        {% for g_name in course.get_group_names() %}
          <span class="group-badge">{{ g_name }}</span>
        {% endfor %}
        {% if not course.get_group_names() %}
          <span class="text-muted">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</span>
        {% endif %}
      </div>
    </div>
  </div>

  {% if groups %}
    {% for g in groups %}
      {% set sc = student_counts.get(g.id, 0) %}
      {% set total_p = total_practices or 0 %}
      {% set done_works = group_work_counts.get(g.id, 0) %}
      {% set max_works = group_max_works.get(g.id, 0) %}
      {% set sum_score = group_score_sums.get(g.id, 0) %}
      {% set max_score = group_max_possible.get(g.id, 0) %}

      <div class="card-course"
           data-href="{{ url_for('course_group', course_id=course.id, group_id=g.id) }}"
           style="cursor: pointer;">
        <div class="course-img-container">
          <div class="group-icon-wrap">
            <i class="bi bi-people-fill"></i>
          </div>
        </div>

        <div class="course-body">
          {% set _perc = ( (done_works * 100 / max_works) if max_works else 0 ) %}
          {% set _perc_int = _perc|round(0)|int %}
          {% set _missing = (max_works - done_works) if max_works else 0 %}

          <div class="d-flex justify-content-between align-items-start gap-3">
            <div class="flex-grow-1" style="min-width: 0;">
              <h4 class="fw-bold m-0 text-body text-truncate" title="{{ g.name }}">{{ g.name }}</h4>

              <div class="meta-line">
                <span><i class="bi bi-people"></i>–°—Ç—É–¥–µ–Ω—Ç–æ–≤: <span class="meta-strong">{{ sc }}</span></span>
                <span><i class="bi bi-journal-check"></i>–ü—Ä–∞–∫—Ç–∏–∫: <span class="meta-strong">{{ total_p }}</span></span>
              </div>

              <div class="meta-line">
                <span><i class="bi bi-check2-square"></i>–†–∞–±–æ—Ç: <span class="meta-strong">{{ done_works }}</span>{% if max_works %} / {{ max_works }}{% endif %}</span>
                <span><i class="bi bi-award"></i>–ë–∞–ª–ª—ã: <span class="meta-strong">{{ '%.2f'|format(sum_score) }}</span>{% if max_score %} / {{ '%.2f'|format(max_score) }}{% endif %}</span>
              </div>
            </div>

            <div class="text-center" style="min-width: 84px;">
              <div class="donut" style="--p: {{ _perc_int }};" title="–°–¥–∞–Ω–æ: {{ done_works }}{% if max_works %} / {{ max_works }}{% endif %}. –ù–µ —Å–¥–∞–Ω–æ: {{ _missing }}">
                <div class="donut-text">{{ _perc_int }}%</div>
              </div>
              <div class="small text-muted mt-1">
                {% if max_works %}
                  {{ done_works }} / {{ max_works }}
                {% else %}
                  –Ω–µ—Ç —Ä–∞–±–æ—Ç
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="text-center py-5 text-muted">
      <i class="bi bi-collection display-4 opacity-25"></i>
      <p class="mt-3">–í —ç—Ç–æ–º –∫—É—Ä—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø.</p>
    </div>
  {% endif %}

</div>

{{ settings_modal(app_version) }}
<div class="modal fade" id="exportExcelModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-earmark-excel me-2"></i>–í—ã–≥—Ä—É–∑–∫–∞ Excel</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if groups %}
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
            <div class="text-muted small">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏</div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" type="button" onclick="setAllExportGroups(true)">
                <i class="bi bi-check2-square me-1"></i>–í—ã–±—Ä–∞—Ç—å –≤—Å—ë
              </button>
              <button class="btn btn-sm btn-outline-secondary" type="button" onclick="setAllExportGroups(false)">
                <i class="bi bi-square me-1"></i>–£–±—Ä–∞—Ç—å –≤—Å—ë
              </button>
            </div>
          </div>

          <div class="border rounded p-2" style="background: var(--rs-card-bg);">
            {% for g in groups %}
              <div class="form-check">
                <input class="form-check-input export-group-cb" type="checkbox" value="{{ g.id }}" id="exp_g{{ g.id }}" checked>
                <label class="form-check-label" for="exp_g{{ g.id }}">{{ g.name }}</label>
              </div>
            {% endfor %}
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="small text-muted" id="exportSelectedCount"></div>
            <div class="small text-muted">–§–∞–π–ª —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ .xlsx</div>
          </div>
        {% else %}
          <div class="text-center text-muted py-4">
            <i class="bi bi-collection display-6 opacity-25"></i>
            <div class="mt-2">–í –∫—É—Ä—Å–µ –Ω–µ—Ç –≥—Ä—É–ø–ø –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏</div>
          </div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-success" type="button" onclick="downloadExcelSelected()" {% if not groups %}disabled{% endif %}>
          <i class="bi bi-download me-1"></i>–°–∫–∞—á–∞—Ç—å
        </button>
      </div>
    </div>
  </div>
</div>

{% if update_available and update_url %}
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ {{ update_remote_version.lstrip('vV') }}üéâ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>
        <div class="text-muted small">–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: <strong>{{ app_version.lstrip('vV') }}</strong></div>
        <div class="text-muted small">–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: <strong>{{ update_remote_version.lstrip('vV') }}</strong></div>

        {% if update_notes %}
        <div class="mt-3">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="toggleNotesBtn" aria-expanded="false">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <div class="mt-2 border rounded p-2 bg-light" id="updateNotes" style="display:none; white-space: pre-wrap; max-height: 260px; overflow:auto;">{{ update_notes }}</div>
        </div>
        {% endif %}
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-primary" type="button" id="viewChangesBtn" data-release-url="{{ update_release_url|default('', true) }}" {% if not update_release_url %}disabled{% endif %}>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <div class="d-flex gap-2 ms-auto">
          <button class="btn btn-outline-secondary" type="button" id="updateLaterBtn" data-bs-dismiss="modal">–ü–æ–∑–∂–µ</button>
          <button class="btn btn-primary" type="button" id="downloadUpdateBtn" data-source-url="{{ (update_source_url or update_url)|default('', true) }}" data-exe-url="{{ update_exe_url|default('', true) }}">–°–∫–∞—á–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="updateDownloadTypeModal" tabindex="-1" aria-labelledby="updateDownloadTypeModalLabel" aria-hidden="true" style="--bs-backdrop-opacity: .94;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateDownloadTypeModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted small mb-3">–î–æ—Å—Ç—É–ø–Ω—ã –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</div>
        <div class="d-grid gap-2">
          <button class="btn btn-outline-secondary text-start" type="button" id="downloadSourceBtn" data-source-url="{{ (update_source_url or update_url)|default('', true) }}">
            –ê—Ä—Ö–∏–≤ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (Open Source, .zip)
          </button>
          <button class="btn btn-outline-primary text-start" type="button" id="downloadExeBtn" data-exe-url="{{ update_exe_url|default('', true) }}" {% if not update_exe_url %}disabled{% endif %}>
            –ì–æ—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è Windows (.exe)
          </button>
        </div>
        {% if not update_exe_url %}
        <div class="small text-muted mt-3">–î–ª—è —ç—Ç–æ–≥–æ —Ä–µ–ª–∏–∑–∞ —Ñ–∞–π–ª .exe –ø–æ–∫–∞ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% if update_available and update_url %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('updateModal');
    const updateModal = modalEl ? new bootstrap.Modal(modalEl) : null;
    if (updateModal) {
      updateModal.show();
    }

    const viewChangesBtn = document.getElementById('viewChangesBtn');
    if (viewChangesBtn) {
      viewChangesBtn.addEventListener('click', () => {
        const rel = viewChangesBtn.dataset.releaseUrl;
        if (rel) window.open(rel, '_blank');
      });
    }

    const btn = document.getElementById('downloadUpdateBtn');
    const downloadTypeModalEl = document.getElementById('updateDownloadTypeModal');
    const downloadTypeModal = downloadTypeModalEl ? new bootstrap.Modal(downloadTypeModalEl) : null;
    if (btn) {
      btn.addEventListener('click', () => {
        if (downloadTypeModal) {
          if (updateModal) updateModal.hide();
          setTimeout(() => downloadTypeModal.show(), 180);
          return;
        }
        const fallbackUrl = btn.dataset.sourceUrl || btn.dataset.exeUrl;
        if (fallbackUrl) window.open(fallbackUrl, '_blank');
      });
    }

    const sourceBtn = document.getElementById('downloadSourceBtn');
    if (sourceBtn) {
      sourceBtn.addEventListener('click', () => {
        const sourceUrl = sourceBtn.dataset.sourceUrl;
        if (sourceUrl) window.open(sourceUrl, '_blank');
      });
    }

    const exeBtn = document.getElementById('downloadExeBtn');
    if (exeBtn) {
      exeBtn.addEventListener('click', () => {
        const exeUrl = exeBtn.dataset.exeUrl;
        if (exeUrl) window.open(exeUrl, '_blank');
      });
    }

    const laterBtn = document.getElementById('updateLaterBtn');
    if (laterBtn) {
      laterBtn.addEventListener('click', () => {
        const tokenMeta = document.querySelector('meta[name="csrf-token"]');
        const token = tokenMeta ? tokenMeta.getAttribute('content') : '';
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['X-CSRFToken'] = token;
        fetch('/api/update/remind_later', {
          method: 'POST',
          headers,
          body: '{}'
        }).catch(() => {});
      });
    }

    const notesBtn = document.getElementById('toggleNotesBtn');
    const notes = document.getElementById('updateNotes');
    if (notesBtn && notes) {
      notesBtn.addEventListener('click', () => {
        const isHidden = notes.style.display === 'none' || !notes.style.display;
        notes.style.display = isHidden ? 'block' : 'none';
        notesBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        notesBtn.textContent = isHidden ? '–°–∫—Ä—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      });
    }
  });
</script>
{% endif %}
<script>
  function updateExportSelectedCount() {
    const cbs = Array.from(document.querySelectorAll('.export-group-cb'));
    const checked = cbs.filter(cb => cb.checked).length;
    const el = document.getElementById('exportSelectedCount');
    if (el) el.textContent = `–í—ã–±—Ä–∞–Ω–æ –≥—Ä—É–ø–ø: ${checked} –∏–∑ ${cbs.length}`;
  }

  function setAllExportGroups(state) {
    document.querySelectorAll('.export-group-cb').forEach(cb => cb.checked = state);
    updateExportSelectedCount();
  }

  function downloadExcelSelected() {
    const ids = Array.from(document.querySelectorAll('.export-group-cb'))
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    if (!ids.length) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥—Ä—É–ø–ø—É');
      return;
    }
    const url = `{{ url_for('course_export_excel', course_id=course.id) }}?groups=${ids.join(',')}`;
    window.location.href = url;

    const modalEl = document.getElementById('exportExcelModal');
    if (modalEl) {
      const m = bootstrap.Modal.getInstance(modalEl);
      if (m) m.hide();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.card-course[data-href]').forEach(card => {
      card.addEventListener('click', () => {
        window.location.href = card.dataset.href;
      });
    });

    const modalEl = document.getElementById('exportExcelModal');
    if (modalEl) {
      modalEl.addEventListener('show.bs.modal', () => updateExportSelectedCount());
      modalEl.addEventListener('change', (e) => {
        if (e.target && e.target.classList && e.target.classList.contains('export-group-cb')) {
          updateExportSelectedCount();
        }
      });
    }
  });
</script>

</body>
</html>
