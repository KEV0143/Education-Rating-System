<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="greeting-name" content="{{ greeting_name|default('', true)|e }}">
    <title>–†–µ–π—Ç–∏–Ω–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</title>

    <script>
      (() => {
        const saved = localStorage.getItem('rs-theme');
        const theme = (saved === 'dark' || saved === 'light') ? saved : 'light';
        document.documentElement.setAttribute('data-bs-theme', theme);
      })();
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <link rel="icon" href="{{ url_for('static', filename='iconkev.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='iconkev.ico') }}" type="image/x-icon">

    <style>
        :root{
            --rs-page-bg: #f8f9fa;
            --rs-text: #333;
            --rs-card-bg: #ffffff;
            --rs-border: #eee;
            --rs-soft-border: #dee2e6;
            --rs-img-bg: #f1f3f5;
            --rs-shadow: rgba(0,0,0,0.03);
            --rs-shadow-hover: rgba(0,0,0,0.08);
            --rs-hover-bg: #f1f3f5;
        }
        :root[data-bs-theme="dark"]{
            --rs-page-bg: #0f1216;
            --rs-text: #e9ecef;
            --rs-card-bg: #151a21;
            --rs-border: rgba(255,255,255,0.08);
            --rs-soft-border: rgba(255,255,255,0.14);
            --rs-img-bg: #0e1116;
            --rs-shadow: rgba(0,0,0,0.35);
            --rs-shadow-hover: rgba(0,0,0,0.55);
            --rs-hover-bg: rgba(255,255,255,0.06);
        }

        body { background-color: var(--rs-page-bg); color: var(--rs-text); font-family: 'Segoe UI', system-ui, sans-serif; }
        .card-course {
            display: flex;
            background: var(--rs-card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 5px var(--rs-shadow);
            transition: 0.3s;
            margin-bottom: 20px;
            align-items: stretch;
            border: 1px solid var(--rs-border);
            height: 160px;
            overflow: visible;
            position: relative;
        }
        .card-course:hover { box-shadow: 0 8px 20px var(--rs-shadow-hover); transform: translateY(-2px); z-index: 10; }
        .course-img-container {
            width: 240px;
            min-width: 240px;
            background-color: var(--rs-img-bg);
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .course-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .course-body { flex-grow: 1; padding: 15px 20px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .dropdown-menu { z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }

        .reason-badge {
            background-color: #eef2ff; color: #4f46e5;
            font-size: 0.75rem; padding: 3px 8px; border-radius: 6px;
            margin-bottom: 6px; display: inline-block; border: 1px solid #e0e7ff;
            font-weight: 600; white-space: nowrap;
        }
        .group-badge {
            font-size: 0.75rem; padding: 4px 8px; border-radius: 6px;
            background: #0d6efd; color: white; text-decoration: none;
            display: inline-block; margin-right: 5px;
        }

        .filter-btn {
            background-color: var(--rs-card-bg); border: 1px solid var(--rs-soft-border); color: var(--rs-text);
            text-align: left; display: flex; justify-content: space-between; align-items: center;
        }
        .filter-btn:hover, .filter-btn:focus, .filter-btn:active {
            background-color: var(--rs-card-bg); border-color: #86b7fe; color: var(--rs-text);
            box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
        }
        .dropdown-menu-scroll { max-height: 250px; overflow-y: auto; }
        .filter-search-input { margin: 5px 10px; width: auto; }

        .group-list-item { cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: 0.2s; border-bottom: 1px solid rgba(0,0,0,0.04);}
        :root[data-bs-theme="dark"] .group-list-item { border-bottom: 1px solid rgba(255,255,255,0.06); }
        .group-list-item:hover { background-color: var(--rs-hover-bg); }
        .group-list-item.active { background-color: #0d6efd; color: white; }

        .group-del-btn{
            opacity: 0;
            padding: 0;
            line-height: 1;
            transition: opacity .15s;
        }
        .group-list-item:hover .group-del-btn,
        .group-list-item.active .group-del-btn{
            opacity: 1;
        }
        .student-scroll-area { height: 400px; overflow-y: auto; border: 1px solid var(--rs-soft-border); border-radius: 6px; background: var(--rs-card-bg); }
        .checkbox-list-container { max-height: 200px; overflow-y: auto; border: 1px solid var(--rs-soft-border); border-radius: 6px; padding: 10px; }

        :root[data-bs-theme="dark"] .reason-badge{
            background-color: rgba(99,102,241,0.18);
            border-color: rgba(99,102,241,0.35);
            color: #c7d2fe;
        }

        :root[data-bs-theme="dark"] .bg-light{ background-color: var(--rs-card-bg) !important; }
        :root[data-bs-theme="dark"] .bg-white{ background-color: var(--rs-card-bg) !important; }
        :root[data-bs-theme="dark"] .text-dark{ color: var(--rs-text) !important; }
    </style>
</head>
<body>
{% from "partials/settings.html" import settings_button, settings_modal %}

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="m-0 fw-bold" id="greetingTitle">
          –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ{% if greeting_name %}, {{ greeting_name }}{% endif %}! üëã
        </h2>
        <div class="d-flex align-items-center flex-wrap gap-2">
            {{ settings_button() }}

            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#archiveModal">
                <i class="bi bi-archive"></i> –ê—Ä—Ö–∏–≤
            </button>

            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#studentsModal">
                <i class="bi bi-people-fill"></i> –ë–∞–∑–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#manageModal" onclick="prepareCreateCourseUX()">
                <i class="bi bi-plus-lg"></i> –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm p-3 mb-4">
        <form action="/" method="GET" id="filterForm">
            <input type="hidden" name="year" id="inputYear" value="{{ selected_year or '' }}">
            <input type="hidden" name="semester" id="inputSemester" value="{{ selected_sem or '' }}">
            <input type="hidden" name="group_id" id="inputGroupId" value="{{ selected_group_id or '' }}">
            <input type="hidden" name="sort" id="inputSort" value="{{ selected_sort or 'title_asc' }}">

            <div class="input-group mb-3">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" name="search" class="form-control border-start-0" placeholder="–ü–æ–∏—Å–∫: –§–ò–û, –ì—Ä—É–ø–ø–∞ –∏–ª–∏ –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞..." value="{{ search }}">
                <button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏</button>
                {% if search %} <a href="/" class="btn btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a> {% endif %}
            </div>

            {% if not search %}
            <div class="row g-2">
                <div class="col-md-3">
                    <div class="dropdown">
                        <button class="btn filter-btn w-100 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <span id="labelYear">{{ selected_year if selected_year else "–í—Å–µ –≥–æ–¥—ã" }}</span>
                        </button>
                        <div class="dropdown-menu w-100 dropdown-menu-scroll">
                            <input type="text" class="form-control form-control-sm filter-search-input" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterDropdown(this)">
                            <a class="dropdown-item" href="#" onclick="setFilter('year','')">–í—Å–µ –≥–æ–¥—ã</a>
                            {% for y in years %} <a class="dropdown-item" href="#" onclick="setFilter('year','{{ y }}')">{{ y }}</a> {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="dropdown">
                        <button class="btn filter-btn w-100 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <span id="labelSemester">{{ selected_sem if selected_sem else "–í—Å–µ" }}</span>
                        </button>
                        <div class="dropdown-menu w-100 dropdown-menu-scroll">
                            <a class="dropdown-item" href="#" onclick="setFilter('semester','')">–í—Å–µ</a>
                            {% for i in range(1, 11) %}
                                <a class="dropdown-item" href="#" onclick="setFilter('semester','{{ i }}')">{{ i }}</a>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="dropdown">
                        <button class="btn filter-btn w-100 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <span id="labelGroup" class="text-truncate">
                                {% if selected_group_id %}
                                    {% for g in groups %}{% if g.id|string == selected_group_id %}{{ g.name }}{% endif %}{% endfor %}
                                {% else %}
                                    –í—Å–µ –≥—Ä—É–ø–ø—ã
                                {% endif %}
                            </span>
                        </button>
                        <div class="dropdown-menu w-100 dropdown-menu-scroll" id="filterGroupDropdownMenu">
                            <input type="text" class="form-control form-control-sm filter-search-input" placeholder="–ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø—ã..." onkeyup="filterDropdown(this)">
                            <a class="dropdown-item" href="#" onclick="setFilter('group_id','')">–í—Å–µ –≥—Ä—É–ø–ø—ã</a>
                            {% for g in groups %}
                                <a class="dropdown-item filter-group-item" href="#" data-group-id="{{ g.id }}" data-group-name="{{ g.name }}" onclick="setFilter('group_id','{{ g.id }}')">{{ g.name }}</a>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="dropdown">
                        <button class="btn filter-btn w-100 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <span id="labelSort">{{ sort_label }}</span>
                        </button>
                        <div class="dropdown-menu w-100 dropdown-menu-scroll">
                            <a class="dropdown-item" href="#" onclick="setFilter('sort','title_asc')">–ù–∞–∑–≤–∞–Ω–∏–µ (–ê‚Äì–Ø)</a>
                            <a class="dropdown-item" href="#" onclick="setFilter('sort','title_desc')">–ù–∞–∑–≤–∞–Ω–∏–µ (–Ø‚Äì–ê)</a>
                            <hr class="dropdown-divider">
                            <a class="dropdown-item" href="#" onclick="setFilter('sort','year_desc')">–ì–æ–¥ (–Ω–æ–≤—ã–µ)</a>
                            <a class="dropdown-item" href="#" onclick="setFilter('sort','year_asc')">–ì–æ–¥ (—Å—Ç–∞—Ä—ã–µ)</a>
                            <hr class="dropdown-divider">
                            <a class="dropdown-item" href="#" onclick="setFilter('sort','semester_desc')">–°–µ–º–µ—Å—Ç—Ä (—É–±—ã–≤.)</a>
                            <a class="dropdown-item" href="#" onclick="setFilter('sort','semester_asc')">–°–µ–º–µ—Å—Ç—Ä (–≤–æ–∑—Ä.)</a>
                        </div>
                    </div>
                </div>

            </div>
            {% endif %}
        </form>
    </div>

    {% if search %} <div class="mb-3 text-muted ps-1">–ù–∞–π–¥–µ–Ω–æ –∫—É—Ä—Å–æ–≤: {{ results|length }}</div> {% endif %}

  <div class="row">
        {% if results %}
            {% for item in results %}
            {% set course = item.course %}
            <div class="col-12">
                <div class="card-course" data-href="{{ url_for('course_detail', course_id=course.id) }}">
                    <div class="course-img-container">
                        <img src="{{ url_for('course_image', course_id=course.id) }}" class="course-img" onerror="this.src='/placeholder'">
                    </div>

                    <div class="course-body">
                        {% if item.reason %}
                            <div><span class="reason-badge"><i class="bi bi-check-circle-fill me-1"></i>{{ item.reason }}</span></div>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h4 class="fw-bold m-0 text-body text-truncate" title="{{ course.title }}">{{ course.title }}</h4>

                            <div class="dropdown ms-2">
                                <button class="btn btn-light btn-sm rounded-circle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="#"
                                           data-id="{{ course.id }}"
                                           data-title="{{ course.title }}"
                                           data-year="{{ course.year }}"
                                           data-semester="{{ course.semester }}"
                                           data-groupids="{{ course.group_ids }}"
                                           onclick="openEditModal(this)">
                                           <i class="bi bi-pencil-fill me-2 text-primary"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                        </a>
                                    </li>
                                    <li>
                                        <form action="/archive_course/{{ course.id }}" method="POST" onsubmit="return confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫—É—Ä—Å –≤ –∞—Ä—Ö–∏–≤?')" class="m-0 p-0">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <button type="submit" class="dropdown-item">
                                                <i class="bi bi-archive-fill me-2 text-secondary"></i>–í –∞—Ä—Ö–∏–≤
                                            </button>
                                        </form>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form action="/delete_course/{{ course.id }}" method="POST" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å?')" class="m-0 p-0">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="bi bi-trash-fill me-2"></i>–£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="text-muted small mb-2">
                            <i class="bi bi-calendar"></i> {{ course.year }} &nbsp;|&nbsp;
                            <i class="bi bi-journal"></i> {{ course.semester }} —Å–µ–º–µ—Å—Ç—Ä
                        </div>

                        <div style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                            {% for g_name in course.get_group_names() %}
                                <span class="group-badge">{{ g_name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center py-5 text-muted">
                <i class="bi bi-search display-4 opacity-25"></i>
                <p class="mt-3">–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
            </div>
        {% endif %}
    </div>

</div>

{{ settings_modal(app_version) }}
<div class="modal fade" id="manageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">–ù–æ–≤—ã–π –∫—É—Ä—Å</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form action="/add_course" method="POST" enctype="multipart/form-data" id="createCourseForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                    <div class="mb-2">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</label>
                        <input type="text" name="title" class="form-control" required id="createTitleInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑">
                    </div>

                    <div class="row mb-2">
                        <div class="col">
                            <label>–ì–æ–¥</label>
                            <input list="yearSuggestions" type="text" name="year" class="form-control" id="createYearInput" placeholder="2024-2025">
                            <datalist id="yearSuggestions">
                                {% for y in years %}<option value="{{ y }}"></option>{% endfor %}
                            </datalist>
                        </div>
                        <div class="col">
                            <label>–°–µ–º–µ—Å—Ç—Ä</label>
                            <select name="semester" class="form-select" id="createSemesterSelect">
                                {% for i in range(1, 11) %}<option value="{{i}}">{{i}}</option>{% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label class="m-0">–ì—Ä—É–ø–ø—ã</label>
                            <span class="badge bg-secondary" id="createGroupsCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
                        </div>

                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllGroups('createGroupList', true)">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllGroups('createGroupList', false)">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>

                        <input type="text" class="form-control form-control-sm mb-2 mt-2" placeholder="–ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É..." onkeyup="filterCheckboxes(this, 'createGroupList')">
                        <div class="checkbox-list-container" id="createGroupList">
                            {% for g in groups %}
                            <div class="form-check course-group-row" data-group-id="{{ g.id }}">
                                <input class="form-check-input create-group-cb" type="checkbox" name="groups" value="{{ g.id }}" id="c_chk{{ g.id }}" onchange="updateCreateGroupsCount()">
                                <label class="form-check-label w-100" for="c_chk{{ g.id }}">{{ g.name }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label>–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="file" name="image" class="form-control" accept="image/*">
                        <div class="form-text">–ú–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å ‚Äî –±—É–¥–µ—Ç –∑–∞–≥–ª—É—à–∫–∞.</div>
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check2-circle me-1"></i> –°–æ–∑–¥–∞—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="editCourseForm" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="mb-2"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</label><input type="text" name="title" id="editTitle" class="form-control" required></div>
                    <div class="row mb-2">
                        <div class="col"><label>–ì–æ–¥</label><input type="text" name="year" id="editYear" class="form-control"></div>
                        <div class="col">
                            <label>–°–µ–º–µ—Å—Ç—Ä</label>
                            <select name="semester" id="editSemester" class="form-select">
                                {% for i in range(1, 11) %}<option value="{{i}}">{{i}}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3"><label>–ì—Ä—É–ø–ø—ã</label>
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="–ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É..." onkeyup="filterCheckboxes(this, 'editGroupList')">
                        <div class="checkbox-list-container" id="editGroupList">
                            {% for g in groups %}
                            <div class="form-check course-group-row" data-group-id="{{ g.id }}">
                                <input class="form-check-input" type="checkbox" name="groups" value="{{ g.id }}" id="e_chk{{ g.id }}">
                                <label class="form-check-label w-100" for="e_chk{{ g.id }}">{{ g.name }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3"><label>–ù–æ–≤–æ–µ —Ñ–æ—Ç–æ</label><input type="file" name="image" class="form-control" accept="image/*"></div>
                    <button type="submit" class="btn btn-primary w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="archiveModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-archive me-2"></i>–ê—Ä—Ö–∏–≤ –∫—É—Ä—Å–æ–≤</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if archived_courses %}
                    <div class="list-group">
                        {% for c in archived_courses %}
                            <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
                                <div class="me-auto">
                                    <div class="fw-semibold text-body">{{ c.title }}</div>
                                    <div class="text-muted small mt-1">
                                        <i class="bi bi-calendar"></i> {{ c.year }} &nbsp;|&nbsp;
                                        <i class="bi bi-journal"></i> {{ c.semester }} —Å–µ–º–µ—Å—Ç—Ä
                                    </div>
                                    <div class="mt-2" style="overflow:hidden; white-space: nowrap; text-overflow: ellipsis;">
                                        {% for g_name in c.get_group_names() %}
                                            <span class="group-badge">{{ g_name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="d-flex gap-2 flex-wrap justify-content-end">
                                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('course_detail', course_id=c.id) }}" title="–û—Ç–∫—Ä—ã—Ç—å –∫—É—Ä—Å">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                    <form action="/unarchive_course/{{ c.id }}" method="POST" class="m-0">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="bi bi-arrow-counterclockwise me-1"></i>–í–µ—Ä–Ω—É—Ç—å
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-archive display-6 opacity-25"></i>
                        <div class="mt-2">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="studentsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content h-100">
            <div class="modal-header">
                <h5 class="modal-title">–ë–∞–∑–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <div class="row g-0 h-100">
                    <div class="col-md-3 border-end bg-light p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-muted small fw-bold m-0">–ì—Ä—É–ø–ø—ã</h6>
                        </div>

                        <div class="input-group mb-3">
                            <input type="text" id="newGroupName" class="form-control form-control-sm" placeholder="–ù–æ–≤–∞—è..." onkeydown="if(event.key==='Enter'){event.preventDefault(); createGroup();}">
                            <button class="btn btn-success btn-sm" type="button" onclick="createGroup()">+</button>
                        </div>

                        <div style="height: 400px; overflow-y: auto;">
                            <div id="groupsListContainer">
                                {% for g in groups %}
                                <div class="group-list-item d-flex justify-content-between align-items-center" data-id="{{ g.id }}" data-name="{{ g.name }}" onclick="selectGroup(this)">
                                    <span class="group-name text-truncate">{{ g.name }}</span>
                                    <button type="button" class="btn btn-sm btn-link text-danger text-decoration-none group-del-btn" title="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É"
                                            onclick="event.stopPropagation(); deleteGroupFromBtn(this);">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5 border-end p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="m-0">–°—Ç—É–¥–µ–Ω—Ç—ã</h6>
                            <span id="currentGroupTitle" class="badge bg-secondary">--</span>
                        </div>
                        <div class="student-scroll-area p-2" id="studentsListArea">
                            <p class="text-center text-muted mt-5">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</p>
                        </div>
                    </div>

                    <div class="col-md-4 p-3 bg-light">
                        <div id="actionBlock" style="display:none;">
                            <label class="small fw-bold">–î–æ–±–∞–≤–∏—Ç—å</label>
                            <textarea id="bulkStudentsText" class="form-control mb-2" rows="8" placeholder="–°–ø–∏—Å–æ–∫..."></textarea>
                            <button class="btn btn-primary w-100 mb-4" type="button" onclick="addStudentsBulk()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

                            <hr>

                            <label class="small">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</label>
                            <div class="input-group mb-2">
                                <input type="text" id="renameGroupInput" class="form-control form-control-sm">
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="renameGroup()">–û–ö</button>
                            </div>

                            <div class="text-muted small">
                                <i class="bi bi-info-circle"></i> –£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã —É–¥–∞–ª–∏—Ç –≤—Å–µ—Ö –µ—ë —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ —É–±–µ—Ä—ë—Ç –≥—Ä—É–ø–ø—É –∏–∑ –∫—É—Ä—Å–æ–≤.
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


<div class="modal fade" id="greetingNameModal" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è</h5>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-2">–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?</p>
        <input type="text" class="form-control" id="greetingNameInput"
               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ª–∏–º–∫–∏–Ω –ï–≥–æ—Ä –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–∏—á" maxlength="80" autocomplete="name">
        <div class="invalid-feedback">–í–≤–µ–¥–∏—Ç–µ –∏–º—è.</div>
        <div class="form-text">–ò–º—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–∑–µ –∏ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å—Å—è.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="button" id="saveGreetingNameBtn">
          <i class="bi bi-check2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
      </div>
    </div>
  </div>
</div>

{% if update_available and update_url %}
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ {{ update_remote_version.lstrip('vV') }}üéâ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>
        <div class="text-muted small">–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: <strong>{{ app_version.lstrip('vV') }}</strong></div>
        <div class="text-muted small">–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: <strong>{{ update_remote_version.lstrip('vV') }}</strong></div>

      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-primary" type="button" id="viewChangesBtn" data-release-url="{{ update_release_url|default('', true) }}" {% if not update_release_url %}disabled{% endif %}>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <div class="d-flex gap-2 ms-auto">
          <button class="btn btn-outline-secondary" type="button" id="updateLaterBtn" data-bs-dismiss="modal">–ü–æ–∑–∂–µ</button>
          <button class="btn btn-primary" type="button" id="downloadUpdateBtn" data-source-url="{{ (update_source_url or update_url)|default('', true) }}" data-exe-url="{{ update_exe_url|default('', true) }}">–°–∫–∞—á–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="updateDownloadTypeModal" tabindex="-1" aria-labelledby="updateDownloadTypeModalLabel" aria-hidden="true" style="--bs-backdrop-opacity: .94;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateDownloadTypeModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted small mb-3">–î–æ—Å—Ç—É–ø–Ω—ã –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</div>
        <div class="d-grid gap-2">
          <button class="btn btn-outline-secondary text-start" type="button" id="downloadSourceBtn" data-source-url="{{ (update_source_url or update_url)|default('', true) }}">
            –ê—Ä—Ö–∏–≤ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (Open Source, .zip)
          </button>
          <button class="btn btn-outline-primary text-start" type="button" id="downloadExeBtn" data-exe-url="{{ update_exe_url|default('', true) }}" {% if not update_exe_url %}disabled{% endif %}>
            –ì–æ—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è Windows (.exe)
          </button>
        </div>
        {% if not update_exe_url %}
        <div class="small text-muted mt-3">–î–ª—è —ç—Ç–æ–≥–æ —Ä–µ–ª–∏–∑–∞ —Ñ–∞–π–ª .exe –ø–æ–∫–∞ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% if update_available and update_url %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('updateModal');
    const updateModal = modalEl ? new bootstrap.Modal(modalEl) : null;
    if (updateModal) {
      updateModal.show();
    }

    const viewChangesBtn = document.getElementById('viewChangesBtn');
    if (viewChangesBtn) {
      viewChangesBtn.addEventListener('click', () => {
        const rel = viewChangesBtn.dataset.releaseUrl;
        if (rel) window.open(rel, '_blank');
      });
    }

    const btn = document.getElementById('downloadUpdateBtn');
    const downloadTypeModalEl = document.getElementById('updateDownloadTypeModal');
    const downloadTypeModal = downloadTypeModalEl ? new bootstrap.Modal(downloadTypeModalEl) : null;
    if (btn) {
      btn.addEventListener('click', () => {
        if (downloadTypeModal) {
          if (updateModal) updateModal.hide();
          setTimeout(() => downloadTypeModal.show(), 180);
          return;
        }
        const fallbackUrl = btn.dataset.sourceUrl || btn.dataset.exeUrl;
        if (fallbackUrl) window.open(fallbackUrl, '_blank');
      });
    }

    const sourceBtn = document.getElementById('downloadSourceBtn');
    if (sourceBtn) {
      sourceBtn.addEventListener('click', () => {
        const sourceUrl = sourceBtn.dataset.sourceUrl;
        if (sourceUrl) window.open(sourceUrl, '_blank');
      });
    }

    const exeBtn = document.getElementById('downloadExeBtn');
    if (exeBtn) {
      exeBtn.addEventListener('click', () => {
        const exeUrl = exeBtn.dataset.exeUrl;
        if (exeUrl) window.open(exeUrl, '_blank');
      });
    }

    const laterBtn = document.getElementById('updateLaterBtn');
    if (laterBtn) {
      laterBtn.addEventListener('click', () => {
        const tokenMeta = document.querySelector('meta[name="csrf-token"]');
        const token = tokenMeta ? tokenMeta.getAttribute('content') : '';
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['X-CSRFToken'] = token;
        fetch('/api/update/remind_later', {
          method: 'POST',
          headers,
          body: '{}'
        }).catch(() => {});
      });
    }

  });
</script>
{% endif %}
<script>
  const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const GREETING_META = document.querySelector('meta[name="greeting-name"]');
    let GREETING_NAME = (GREETING_META ? GREETING_META.getAttribute('content') : '').trim();

    if (!GREETING_NAME) GREETING_NAME = null;
    if (GREETING_NAME && ['none', 'null', 'undefined'].includes(GREETING_NAME.toLowerCase())) {
      GREETING_NAME = null;
    }

  function setGreetingName(name) {
    const el = document.getElementById('greetingTitle');
    if (!el) return;
    el.textContent = name ? `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${name}! üëã` : '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã';
  }

  async function ensureGreetingName() {
    if (GREETING_NAME) {
      setGreetingName(GREETING_NAME);
      return;
    }

    const modalEl = document.getElementById('greetingNameModal');
    if (!modalEl) {
      setGreetingName(null);
      return;
    }

    const input = document.getElementById('greetingNameInput');
    const btn = document.getElementById('saveGreetingNameBtn');

    const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
    modal.show();
    setTimeout(() => input && input.focus(), 250);

    async function save() {
      const name = (input.value || '').trim();
      if (!name) {
        input.classList.add('is-invalid');
        input.focus();
        return;
      }
      input.classList.remove('is-invalid');
      btn.disabled = true;

      try {
        const r = await fetch('/api/greeting', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
          },
          body: JSON.stringify({ name })
        });

        const d = await r.json();
        if (!d || !d.success) {
          alert((d && d.error) ? d.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è');
          btn.disabled = false;
          return;
        }

        GREETING_NAME = d.name;
        setGreetingName(GREETING_NAME);
        modal.hide();
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏');
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', save);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') save();
    });
  }

  function setFilter(type, value) {
    if (type === 'year') document.getElementById('inputYear').value = value;
    if (type === 'semester') document.getElementById('inputSemester').value = value;
    if (type === 'group_id') document.getElementById('inputGroupId').value = value;
    if (type === 'sort') document.getElementById('inputSort').value = value;
    document.getElementById('filterForm').submit();
  }

  function filterDropdown(input) {
    const f = input.value.toLowerCase();
    const items = input.parentElement.getElementsByClassName('dropdown-item');
    for (let i = 0; i < items.length; i++) {
      items[i].style.display = (items[i].innerText.toLowerCase().indexOf(f) > -1) ? "" : "none";
    }
  }

  function filterCheckboxes(input, containerId) {
    const filter = input.value.toLowerCase();
    const divs = document.getElementById(containerId).getElementsByClassName('form-check');
    for (let i = 0; i < divs.length; i++) {
      const label = divs[i].getElementsByTagName('label')[0];
      divs[i].style.display = (label.innerText.toLowerCase().indexOf(filter) > -1) ? "" : "none";
    }
  }

  function openEditModal(el) {
    document.getElementById('editCourseForm').action = '/edit_course/' + el.dataset.id;
    document.getElementById('editTitle').value = el.dataset.title;
    document.getElementById('editYear').value = el.dataset.year;
    document.getElementById('editSemester').value = el.dataset.semester;

    const raw = (el.dataset.groupids || '').trim();
    const gIds = raw ? raw.split(',') : [];

    document.querySelectorAll('#editGroupList input').forEach(cb => {
      cb.checked = gIds.includes(cb.value);
    });

    new bootstrap.Modal(document.getElementById('editCourseModal')).show();
  }

  function prepareCreateCourseUX() {
    setTimeout(() => {
      const title = document.getElementById('createTitleInput');
      if (title) title.focus();

      const yearInput = document.getElementById('createYearInput');
      if (yearInput && !yearInput.value.trim()) {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth() + 1;
        const start = (m >= 8) ? y : (y - 1);
        yearInput.value = `${start}-${start + 1}`;
      }
      updateCreateGroupsCount();
    }, 150);
  }

  function updateCreateGroupsCount() {
    const cbs = document.querySelectorAll('.create-group-cb');
    let cnt = 0;
    cbs.forEach(cb => { if (cb.checked) cnt++; });
    const badge = document.getElementById('createGroupsCount');
    if (badge) badge.innerText = `${cnt} –≤—ã–±—Ä–∞–Ω–æ`;
  }

  function toggleAllGroups(containerId, state) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = state);
    updateCreateGroupsCount();
  }

  function addGroupToCourseLists(g) {
    const createList = document.getElementById('createGroupList');
    if (createList && !createList.querySelector(`.course-group-row[data-group-id="${g.id}"]`)) {
      const row = document.createElement('div');
      row.className = 'form-check course-group-row';
      row.dataset.groupId = g.id;

      const cb = document.createElement('input');
      cb.className = 'form-check-input create-group-cb';
      cb.type = 'checkbox';
      cb.name = 'groups';
      cb.value = g.id;
      cb.id = 'c_chk' + g.id;
      cb.addEventListener('change', updateCreateGroupsCount);

      const label = document.createElement('label');
      label.className = 'form-check-label w-100';
      label.htmlFor = cb.id;
      label.textContent = g.name;

      row.appendChild(cb);
      row.appendChild(label);
      createList.appendChild(row);
      updateCreateGroupsCount();
    }

    const editList = document.getElementById('editGroupList');
    if (editList && !editList.querySelector(`.course-group-row[data-group-id="${g.id}"]`)) {
      const row = document.createElement('div');
      row.className = 'form-check course-group-row';
      row.dataset.groupId = g.id;

      const cb = document.createElement('input');
      cb.className = 'form-check-input';
      cb.type = 'checkbox';
      cb.name = 'groups';
      cb.value = g.id;
      cb.id = 'e_chk' + g.id;

      const label = document.createElement('label');
      label.className = 'form-check-label w-100';
      label.htmlFor = cb.id;
      label.textContent = g.name;

      row.appendChild(cb);
      row.appendChild(label);
      editList.appendChild(row);
    }

    const menu = document.getElementById('filterGroupDropdownMenu');
    if (menu && !menu.querySelector(`.filter-group-item[data-group-id="${g.id}"]`)) {
      const a = document.createElement('a');
      a.className = 'dropdown-item filter-group-item';
      a.href = '#';
      a.dataset.groupId = g.id;
      a.dataset.groupName = g.name;
      a.textContent = g.name;
      a.addEventListener('click', (ev) => { ev.preventDefault(); setFilter('group_id', String(g.id)); });
      menu.appendChild(a);
    }
  }

  function renameGroupEverywhere(groupId, newName) {
    const item = document.querySelector(`.group-list-item[data-id="${groupId}"]`);
    if (item) {
      item.dataset.name = newName;
      const nameEl = item.querySelector('.group-name');
      if (nameEl) nameEl.textContent = newName;
      else item.textContent = newName;
    }

    const cLabel = document.querySelector(`label[for="c_chk${groupId}"]`);
    if (cLabel) cLabel.textContent = newName;
    const eLabel = document.querySelector(`label[for="e_chk${groupId}"]`);
    if (eLabel) eLabel.textContent = newName;

    const fItem = document.querySelector(`.filter-group-item[data-group-id="${groupId}"]`);
    if (fItem) { fItem.dataset.groupName = newName; fItem.textContent = newName; }

    if (String(activeGroupId) === String(groupId)) {
      document.getElementById('currentGroupTitle').innerText = newName;
    }
  }

  function removeGroupEverywhere(groupId) {
    const item = document.querySelector(`.group-list-item[data-id="${groupId}"]`);
    if (item) item.remove();

    const cRow = document.querySelector(`#createGroupList .course-group-row[data-group-id="${groupId}"]`);
    if (cRow) cRow.remove();
    const eRow = document.querySelector(`#editGroupList .course-group-row[data-group-id="${groupId}"]`);
    if (eRow) eRow.remove();

    const fItem = document.querySelector(`.filter-group-item[data-group-id="${groupId}"]`);
    if (fItem) fItem.remove();

    updateCreateGroupsCount();
  }

  let activeGroupId = null;
  let activeGroupName = null;

  function createGroup() {
    const input = document.getElementById('newGroupName');
    const n = (input.value || '').trim();
    if (!n) return;

    fetch('/api/create_group', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRF_TOKEN
      },
      body: JSON.stringify({ name: n })
    })
      .then(r => r.json())
      .then(d => {
        if (!d.success) {
          alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É');
          return;
        }

        input.value = '';
        const g = d.group;
        const container = document.getElementById('groupsListContainer');
        const div = document.createElement('div');
        div.className = 'group-list-item d-flex justify-content-between align-items-center';
        div.dataset.id = g.id;
        div.dataset.name = g.name;
        div.addEventListener('click', () => selectGroup(div));

        const nameSpan = document.createElement('span');
        nameSpan.className = 'group-name text-truncate';
        nameSpan.textContent = g.name;

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'btn btn-sm btn-link text-danger text-decoration-none group-del-btn';
        delBtn.title = '–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É';
        delBtn.innerHTML = '<i class="bi bi-trash3"></i>';
        delBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteGroupById(String(g.id), g.name);
        });

        div.appendChild(nameSpan);
        div.appendChild(delBtn);
        container.appendChild(div);
        addGroupToCourseLists(g);
        selectGroup(div);
      })
      .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã'));
  }

  function selectGroup(el) {
    activeGroupId = el.dataset.id;
    activeGroupName = el.dataset.name;

    document.querySelectorAll('.group-list-item').forEach(e => e.classList.remove('active'));
    el.classList.add('active');

    document.getElementById('currentGroupTitle').innerText = activeGroupName;
    document.getElementById('renameGroupInput').value = activeGroupName;
    document.getElementById('actionBlock').style.display = 'block';

    loadStudents(activeGroupId);
  }

  function deleteGroupFromBtn(btn) {
    const item = btn && btn.closest ? btn.closest('.group-list-item') : null;
    if (!item) return;
    deleteGroupById(item.dataset.id, item.dataset.name);
  }

  function deleteGroupById(groupId, groupName) {
    if (!groupId) return;

    const name = groupName || '–≥—Ä—É–ø–ø–∞';
    const msg =
      `–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É "${name}" –ø–æ–ª–Ω–æ—Å—Ç—å—é?\n\n` +
      `–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å—Ç—É–¥–µ–Ω—Ç—ã —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –∏ –≥—Ä—É–ø–ø–∞ –±—É–¥–µ—Ç —É–±—Ä–∞–Ω–∞ –∏–∑ –∫—É—Ä—Å–æ–≤.`;

    if (!confirm(msg)) return;

    fetch('/api/delete_group/' + groupId, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN }
    })
      .then(r => r.json())
      .then(d => {
        if (!d.success) {
          alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É');
          return;
        }

        removeGroupEverywhere(groupId);

        if (String(activeGroupId) === String(groupId)) {
          activeGroupId = null;
          activeGroupName = null;
          document.getElementById('currentGroupTitle').innerText = '--';
          document.getElementById('studentsListArea').innerHTML = '<p class="text-center text-muted mt-5">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</p>';
          document.getElementById('actionBlock').style.display = 'none';
        }
      })
      .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã'));
  }

  function deleteStudent(studentId) {
    if (!activeGroupId) return;
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞?')) return;

    fetch('/api/delete_student/' + studentId, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN }
    })
      .then(r => r.json())
      .then(d => {
        if (d.success) loadStudents(activeGroupId);
        else alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞');
      })
      .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞'));
  }

  function loadStudents(id) {
    const area = document.getElementById('studentsListArea');
    area.innerHTML = '<div class="text-center text-muted mt-5">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';

    fetch(`/api/get_students/${id}`)
      .then(r => r.json())
      .then(list => {
        area.innerHTML = '';

        if (!list.length) {
          const empty = document.createElement('div');
          empty.className = 'text-center text-muted mt-5';
          empty.textContent = '–í –≥—Ä—É–ø–ø–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤';
          area.appendChild(empty);
          return;
        }

        const ul = document.createElement('ul');
        ul.className = 'list-group list-group-flush';
        list.forEach((s, idx) => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';

          const left = document.createElement('div');
          left.className = 'd-flex align-items-center gap-2 flex-grow-1';

          const span = document.createElement('span');
          span.className = 'text-truncate';
          span.textContent = `${idx + 1}. ${s.fio}`;
          left.appendChild(span);

          const actions = document.createElement('div');
          actions.className = 'd-flex align-items-center gap-2';

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn btn-sm btn-link text-primary text-decoration-none';
          editBtn.innerHTML = '<i class="bi bi-pencil-square"></i>';
          editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –§–ò–û';
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            startEditStudent(li, s.id, s.fio, idx + 1);
          });

          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'btn btn-sm btn-link text-danger text-decoration-none';
          delBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
          delBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞';
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteStudent(s.id);
          });

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          li.appendChild(left);
          li.appendChild(actions);
          ul.appendChild(li);
        });

        area.appendChild(ul);
      })
      .catch(() => {
        area.innerHTML = '<div class="text-center text-danger mt-5">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      });
  }

  function startEditStudent(li, studentId, fio, num) {
    if (!activeGroupId) return;

    li.innerHTML = '';
    li.className = 'list-group-item d-flex justify-content-between align-items-center';

    const left = document.createElement('div');
    left.className = 'd-flex align-items-center gap-2 flex-grow-1';

    const numSpan = document.createElement('span');
    numSpan.className = 'text-muted';
    numSpan.textContent = `${num}.`;

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control form-control-sm';
    input.value = (fio || '').trim();
    input.maxLength = 150;

    left.appendChild(numSpan);
    left.appendChild(input);

    const actions = document.createElement('div');
    actions.className = 'd-flex align-items-center gap-2';

    const saveBtn = document.createElement('button');
    saveBtn.type = 'button';
    saveBtn.className = 'btn btn-sm btn-success';
    saveBtn.innerHTML = '<i class="bi bi-check2"></i>';
    saveBtn.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';

    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.className = 'btn btn-sm btn-outline-secondary';
    cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
    cancelBtn.title = '–û—Ç–º–µ–Ω–∞';

    saveBtn.addEventListener('click', () => commitEditStudent(studentId, input.value));
    cancelBtn.addEventListener('click', () => loadStudents(activeGroupId));

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        commitEditStudent(studentId, input.value);
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        loadStudents(activeGroupId);
      }
    });

    actions.appendChild(saveBtn);
    actions.appendChild(cancelBtn);

    li.appendChild(left);
    li.appendChild(actions);

    setTimeout(() => {
      input.focus();
      input.select();
    }, 0);
  }

  async function commitEditStudent(studentId, fio) {
    const n = (fio || '').trim();
    if (!n) { alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û'); return; }

    try {
      const r = await fetch('/api/update_student/' + studentId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({ fio: n })
      });
      const d = await r.json();
      if (!d || !d.success) {
        alert((d && d.error) ? d.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
        return;
      }
      loadStudents(activeGroupId);
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
  }

  function renameGroup() {
    const input = document.getElementById('renameGroupInput');
    const n = (input.value || '').trim();
    if (!activeGroupId || !n) return;

    fetch('/api/rename_group', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRF_TOKEN
      },
      body: JSON.stringify({ id: activeGroupId, name: n })
    })
      .then(r => r.json())
      .then(d => {
        if (!d.success) {
          alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É');
          return;
        }
        activeGroupName = d.group.name;
        renameGroupEverywhere(activeGroupId, activeGroupName);
      })
      .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏'));
  }

  function addStudentsBulk() {
    const t = document.getElementById('bulkStudentsText').value;
    if (!activeGroupId || !t.trim()) return;

    fetch('/api/add_students_bulk', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRF_TOKEN
      },
      body: JSON.stringify({ group_id: activeGroupId, text: t })
    })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          document.getElementById('bulkStudentsText').value = '';
          loadStudents(activeGroupId);
        } else {
          alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤');
        }
      })
      .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤'));
  }

  function deleteActiveGroup() {
    if (!activeGroupId) return;
    deleteGroupById(activeGroupId, activeGroupName);
  }

  function wireCourseCardLinks() {
    document.querySelectorAll('.card-course[data-href]').forEach(card => {
      card.style.cursor = 'pointer';
      card.addEventListener('click', (e) => {
        if (
          e.target.closest('.dropdown') ||
          e.target.closest('button') ||
          e.target.closest('form') ||
          e.target.closest('input') ||
          e.target.closest('a')
        ) return;

        window.location.href = card.dataset.href;
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    wireCourseCardLinks();
    updateCreateGroupsCount();
    ensureGreetingName();
  });
</script>


</body>
</html>
