<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{{ course.title }} ‚Äî {{ group.name }}</title>

  <script>
    (() => {
      const saved = localStorage.getItem('rs-theme');
      const theme = (saved === 'dark' || saved === 'light') ? saved : 'light';
      document.documentElement.setAttribute('data-bs-theme', theme);
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <link rel="icon" href="{{ url_for('static', filename='iconkev.ico') }}" type="image/x-icon">
  <link rel="shortcut icon" href="{{ url_for('static', filename='iconkev.ico') }}" type="image/x-icon">

  <style>
    :root{
      --rs-page-bg: #f8f9fa;
      --rs-text: #333;
      --rs-card-bg: #ffffff;
      --rs-border: #eee;
      --rs-soft-border: #dee2e6;
      --rs-img-bg: #f1f3f5;
      --rs-shadow: rgba(0,0,0,0.03);
      --rs-shadow-hover: rgba(0,0,0,0.08);
      --rs-hover-bg: #f1f3f5;
      --rs-muted: #6c757d;
    }
    :root[data-bs-theme="dark"]{
      --rs-page-bg: #0f1216;
      --rs-text: #e9ecef;
      --rs-card-bg: #151a21;
      --rs-border: rgba(255,255,255,0.08);
      --rs-soft-border: rgba(255,255,255,0.14);
      --rs-img-bg: #0e1116;
      --rs-shadow: rgba(0,0,0,0.35);
      --rs-shadow-hover: rgba(0,0,0,0.55);
      --rs-hover-bg: rgba(255,255,255,0.06);
      --rs-muted: rgba(255,255,255,0.65);
    }

    body { background-color: var(--rs-page-bg); color: var(--rs-text); font-family: 'Segoe UI', system-ui, sans-serif; }
    .panel-card { border-radius: 12px; box-shadow: 0 2px 5px var(--rs-shadow); border: 1px solid var(--rs-border); background: var(--rs-card-bg); }
    .students-panel-card { min-height: 0; }
    .student-scroll-area { height: 840px; overflow-y: auto; border: 1px solid var(--rs-soft-border); border-radius: 10px; background: var(--rs-card-bg); }
    #page{ padding-top: 1.25rem !important; padding-bottom: 1rem !important; }
    .small-muted { font-size: .85rem; color: var(--rs-muted); }

    @media (min-width: 992px){
      .panels-row > .col-lg-4,
      .panels-row > .col-lg-8 {
        display: flex;
      }
      .panels-row .panel-card {
        width: 100%;
        height: 100%;
      }
    }

    #practiceChips{
      display: flex !important;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
    }

    .practice-chip {
      cursor: pointer;
      border: 1px solid var(--rs-soft-border);
      background: var(--rs-card-bg);
      border-radius: 10px;
      padding: 5px 10px;
      transition: .15s;
      user-select: none;
      min-width: 0;
      width: 100%;
      min-height: 66px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
    }
    .practice-chip:hover { background: var(--rs-hover-bg); }

    .practice-chip.active {
      background: rgba(99,102,241,0.12);
      border-color: rgba(99,102,241,0.35);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.12);
      color: var(--rs-text);
    }
    .chip-title { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chip-sub { font-size: .76rem; color: var(--rs-muted); }
    .chip-score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 1.3rem;
      line-height: 1;
      padding-top: 0;
      padding-bottom: 0;
    }
    .chip-interval {
      margin-top: 1px;
      line-height: 1.1;
      min-height: 1.6em;
    }

    .score-input,
    .comment-input {
      min-height: 2.15rem;
    }

    .save-indicator { font-size: .85rem; color: var(--rs-muted); }
    .save-indicator.saving { color: #0d6efd; }
    .save-indicator.saved { color: #198754; }
    .save-indicator.error { color: #dc3545; }
    .score-input.filled,
    .comment-input.filled {
      border-color: rgba(13, 110, 253, 0.45);
      box-shadow: 0 0 0 0.08rem rgba(13, 110, 253, 0.12);
    }
    :root[data-bs-theme="dark"] .score-input.filled,
    :root[data-bs-theme="dark"] .comment-input.filled {
      border-color: rgba(173, 181, 189, 0.6);
      box-shadow: 0 0 0 0.08rem rgba(173, 181, 189, 0.18);
    }

    .student-name { cursor: pointer; }

    .donut {
      --p: 0;
      --size: 88px;
      --thickness: 12px;
      --c: var(--bs-success);
      --bg: var(--bs-secondary-bg);
      width: var(--size);
      height: var(--size);
      border-radius: 50%;
      background: conic-gradient(var(--c) calc(var(--p) * 1%), var(--bg) 0);
      position: relative;
      flex: 0 0 auto;
    }
    .donut::after{
      content: '';
      position: absolute;
      inset: var(--thickness);
      background: var(--rs-card-bg);
      border-radius: 50%;
    }
    .donut-text{
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 800;
      line-height: 1;
      color: var(--rs-text);
      z-index: 1;
      user-select: none;
    }

    :root[data-bs-theme="dark"] .bg-light{ background-color: var(--rs-card-bg) !important; }
    :root[data-bs-theme="dark"] .bg-white{ background-color: var(--rs-card-bg) !important; }
    :root[data-bs-theme="dark"] .text-dark{ color: var(--rs-text) !important; }

    @media (max-width: 991.98px){
      .students-panel-card { min-height: auto; }
      .student-scroll-area { height: 560px; }
      #page{ padding-top: 1rem !important; padding-bottom: 1rem !important; }
    }
  </style>
</head>
<body>
{% from "partials/settings.html" import settings_button, settings_modal %}

<div class="container py-4" id="page"
     data-course-id="{{ course.id }}"
     data-group-id="{{ group.id }}">

  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <a href="{{ url_for('course_detail', course_id=course.id) }}" class="btn btn-outline-secondary btn-sm mb-2">
        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É
      </a>
      <h2 class="m-0 fw-bold">{{ group.name }}</h2>
      <div class="text-muted small mt-1">
        <span class="fw-semibold">{{ course.title }}</span> ¬∑ {{ course.year }} ¬∑ {{ course.semester }} —Å–µ–º–µ—Å—Ç—Ä
      </div>
    </div>

    <div class="ms-3">
      <div class="d-flex gap-2 flex-wrap justify-content-end">
        {{ settings_button() }}
        <a class="btn btn-outline-primary"
           href="{{ url_for('course_assessments', course_id=course.id) }}">
          <i class="bi bi-clipboard2-check me-1"></i> –ó–∞–¥–∞–Ω–∏—è –∏ –±–∞–ª–ª—ã
        </a>
      </div>
    </div>
  </div>

  <div class="row g-3 panels-row">
    <div class="col-lg-4">
      <div class="panel-card p-3 students-panel-card">
        <div class="fw-bold mb-2">–ó–∞–¥–∞–Ω–∏—è</div>

        {% if practices %}
          <div class="d-flex flex-wrap gap-2" id="practiceChips">
            {% for p in practices %}
              <div class="practice-chip"
                   data-id="{{ p.id }}"
                   data-title="{{ p.title }}"
                   data-min="{{ p.min_score }}"
                   data-max="{{ p.max_score }}"
                   data-start="{{ p.effective_start_date.isoformat() if p.effective_start_date else '' }}"
                   data-end="{{ p.effective_end_date.isoformat() if p.effective_end_date else '' }}"
                   onclick="selectPractice(this)">
                <div class="d-flex justify-content-between align-items-center gap-2">
                  <div class="chip-title" title="{{ p.title }}">{{ p.title }}</div>
                  <span class="badge bg-primary chip-score-badge">{{ p.min_score }}‚Äì{{ p.max_score }}</span>
                </div>
                <div class="chip-sub chip-interval">
                  {% if p.effective_start_date and p.effective_end_date %}
                    –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {{ p.effective_start_date.strftime('%d.%m.%Y') }} ‚Äî {{ p.effective_end_date.strftime('%d.%m.%Y') }}
                  {% elif p.effective_start_date %}
                    –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: —Å {{ p.effective_start_date.strftime('%d.%m.%Y') }}
                  {% elif p.effective_end_date %}
                    –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –¥–æ {{ p.effective_end_date.strftime('%d.%m.%Y') }}
                  {% else %}
                    –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –Ω–µ –∑–∞–¥–∞–Ω—ã
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è –≤ ‚Äú–ó–∞–¥–∞–Ω–∏—è –∏ –±–∞–ª–ª—ã‚Äù.</div>
        {% endif %}

        <hr>

        <div class="fw-semibold mb-2">–ú–∞—Å—Å–æ–≤–æ</div>
        <input class="form-control mb-2" id="bulkScore" type="number" step="0.5" placeholder="–ë–∞–ª–ª">
        <input class="form-control mb-2" id="bulkComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" type="button" onclick="applyBulkSelected()">
            <i class="bi bi-check2-square me-1"></i> –ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º
          </button>
          <button class="btn btn-primary" type="button" onclick="applyBulkAllGroup()">
            <i class="bi bi-check2-all me-1"></i> –ö–æ –≤—Å–µ–º
          </button>
        </div>

        <div class="small-muted mt-2">
          –í—ã–¥–µ–ª—è–π—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥–∞–ª–æ—á–∫–∞–º–∏ —Å–ª–µ–≤–∞ –æ—Ç –§–ò–û.
        </div>

        <div class="mt-3 pt-2 border-top">
          <button class="btn btn-outline-secondary w-100" type="button" onclick="openIntervalModal()">
            <i class="bi bi-calendar-range me-1"></i> –ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∞–∫—Ç–∏–∫–∏
          </button>
          <div class="small-muted mt-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–π –≥—Ä—É–ø–ø–µ.</div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="panel-card p-3 students-panel-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-bold">–°—Ç—É–¥–µ–Ω—Ç—ã</div>
          <div class="save-indicator" id="globalSaveIndicator">‚Äî</div>
        </div>

        <input class="form-control mb-2" id="studentSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û..." oninput="filterStudents()">

        <div class="student-scroll-area p-2" id="studentsArea">
          <div class="text-center text-muted mt-5">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</div>
        </div>
      </div>
    </div>
  </div>

</div>

{{ settings_modal(app_version) }}
<div class="modal fade" id="studentStatsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statsTitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="statsBody">
        <div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="practiceIntervalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∞–∫—Ç–∏–∫–∏</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col">
            <label class="form-label mb-1">–°</label>
            <input class="form-control" id="intervalStartDate" type="date">
          </div>
          <div class="col">
            <label class="form-label mb-1">–ü–æ</label>
            <input class="form-control" id="intervalEndDate" type="date">
          </div>
        </div>
        <div class="small-muted mt-2">–û—Å—Ç–∞–≤—å—Ç–µ –æ–±–µ –¥–∞—Ç—ã –ø—É—Å—Ç—ã–º–∏, –µ—Å–ª–∏ —Å—Ä–æ–∫–∏ –Ω–µ –Ω—É–∂–Ω—ã –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" onclick="clearIntervalInputs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn btn-primary" type="button" onclick="saveGroupInterval()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

{% if update_available and update_url %}
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ {{ update_remote_version.lstrip('vV') }}üéâ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>
        <div class="text-muted small">–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: <strong>{{ app_version.lstrip('vV') }}</strong></div>
        <div class="text-muted small">–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: <strong>{{ update_remote_version.lstrip('vV') }}</strong></div>

        {% if update_notes %}
        <div class="mt-3">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="toggleNotesBtn" aria-expanded="false">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <div class="mt-2 border rounded p-2 bg-light" id="updateNotes" style="display:none; white-space: pre-wrap; max-height: 260px; overflow:auto;">{{ update_notes }}</div>
        </div>
        {% endif %}
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-primary" type="button" id="viewChangesBtn" data-release-url="{{ update_release_url|default('', true) }}" {% if not update_release_url %}disabled{% endif %}>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <div class="d-flex gap-2 ms-auto">
          <button class="btn btn-outline-secondary" type="button" id="updateLaterBtn" data-bs-dismiss="modal">–ü–æ–∑–∂–µ</button>
          <button class="btn btn-primary" type="button" id="downloadUpdateBtn" data-source-url="{{ (update_source_url or update_url)|default('', true) }}" data-exe-url="{{ update_exe_url|default('', true) }}">–°–∫–∞—á–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="updateDownloadTypeModal" tabindex="-1" aria-labelledby="updateDownloadTypeModalLabel" aria-hidden="true" style="--bs-backdrop-opacity: .94;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateDownloadTypeModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted small mb-3">–î–æ—Å—Ç—É–ø–Ω—ã –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</div>
        <div class="d-grid gap-2">
          <button class="btn btn-outline-secondary text-start" type="button" id="downloadSourceBtn" data-source-url="{{ (update_source_url or update_url)|default('', true) }}">
            –ê—Ä—Ö–∏–≤ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (Open Source, .zip)
          </button>
          <button class="btn btn-outline-primary text-start" type="button" id="downloadExeBtn" data-exe-url="{{ update_exe_url|default('', true) }}" {% if not update_exe_url %}disabled{% endif %}>
            –ì–æ—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è Windows (.exe)
          </button>
        </div>
        {% if not update_exe_url %}
        <div class="small text-muted mt-3">–î–ª—è —ç—Ç–æ–≥–æ —Ä–µ–ª–∏–∑–∞ —Ñ–∞–π–ª .exe –ø–æ–∫–∞ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% if update_available and update_url %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('updateModal');
    const updateModal = modalEl ? new bootstrap.Modal(modalEl) : null;
    if (updateModal) {
      updateModal.show();
    }

    const viewChangesBtn = document.getElementById('viewChangesBtn');
    if (viewChangesBtn) {
      viewChangesBtn.addEventListener('click', () => {
        const rel = viewChangesBtn.dataset.releaseUrl;
        if (rel) window.open(rel, '_blank');
      });
    }

    const btn = document.getElementById('downloadUpdateBtn');
    const downloadTypeModalEl = document.getElementById('updateDownloadTypeModal');
    const downloadTypeModal = downloadTypeModalEl ? new bootstrap.Modal(downloadTypeModalEl) : null;
    if (btn) {
      btn.addEventListener('click', () => {
        if (downloadTypeModal) {
          if (updateModal) updateModal.hide();
          setTimeout(() => downloadTypeModal.show(), 180);
          return;
        }
        const fallbackUrl = btn.dataset.sourceUrl || btn.dataset.exeUrl;
        if (fallbackUrl) window.open(fallbackUrl, '_blank');
      });
    }

    const sourceBtn = document.getElementById('downloadSourceBtn');
    if (sourceBtn) {
      sourceBtn.addEventListener('click', () => {
        const sourceUrl = sourceBtn.dataset.sourceUrl;
        if (sourceUrl) window.open(sourceUrl, '_blank');
      });
    }

    const exeBtn = document.getElementById('downloadExeBtn');
    if (exeBtn) {
      exeBtn.addEventListener('click', () => {
        const exeUrl = exeBtn.dataset.exeUrl;
        if (exeUrl) window.open(exeUrl, '_blank');
      });
    }

    const laterBtn = document.getElementById('updateLaterBtn');
    if (laterBtn) {
      laterBtn.addEventListener('click', () => {
        const tokenMeta = document.querySelector('meta[name="csrf-token"]');
        const token = tokenMeta ? tokenMeta.getAttribute('content') : '';
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['X-CSRFToken'] = token;
        fetch('/api/update/remind_later', {
          method: 'POST',
          headers,
          body: '{}'
        }).catch(() => {});
      });
    }

    const notesBtn = document.getElementById('toggleNotesBtn');
    const notes = document.getElementById('updateNotes');
    if (notesBtn && notes) {
      notesBtn.addEventListener('click', () => {
        const isHidden = notes.style.display === 'none' || !notes.style.display;
        notes.style.display = isHidden ? 'block' : 'none';
        notesBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        notesBtn.textContent = isHidden ? '–°–∫—Ä—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      });
    }
  });
</script>
{% endif %}
<script>
  const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const pageEl = document.getElementById('page');
  const COURSE_ID = Number(pageEl.dataset.courseId);
  const GROUP_ID = Number(pageEl.dataset.groupId);

  let activePracticeId = null;
  let activePracticeMin = 0;
  let activePracticeMax = 10;
  let activePracticeStartDate = null;
  let activePracticeEndDate = null;
  let intervalModalInstance = null;

  const saveTimers = new Map();
  const lastPayload = new Map();

  function formatTs(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return String(iso);
    return d.toLocaleString('ru-RU', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function normalizeIsoDate(value) {
    const s = String(value || '').trim();
    return s ? s.slice(0, 10) : null;
  }

  function formatDateOnly(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return String(iso);
    return d.toLocaleDateString('ru-RU', {
      year: 'numeric', month: '2-digit', day: '2-digit'
    });
  }

  function formatIntervalText(startIso, endIso) {
    const start = normalizeIsoDate(startIso);
    const end = normalizeIsoDate(endIso);
    if (!start && !end) return '–Ω–µ –∑–∞–¥–∞–Ω—ã';
    if (start && end) return `${formatDateOnly(start)} ‚Äî ${formatDateOnly(end)}`;
    if (start) return `—Å ${formatDateOnly(start)}`;
    return `–¥–æ ${formatDateOnly(end)}`;
  }

  function getIntervalDisplayText(startIso, endIso) {
    return `–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${formatIntervalText(startIso, endIso)}`;
  }

  function renderChipInterval(chipEl, startIso, endIso) {
    if (!chipEl) return;
    const intervalEl = chipEl.querySelector('.chip-interval');
    if (!intervalEl) return;
    intervalEl.textContent = getIntervalDisplayText(startIso, endIso);
  }

  function getPracticeIndicatorText() {
    return `–ë–∞–ª–ª—ã: ${activePracticeMin} ‚Äî ${activePracticeMax} | ${getIntervalDisplayText(activePracticeStartDate, activePracticeEndDate)}`;
  }

  function setFilledState(inputEl) {
    if (!inputEl) return;
    const hasValue = String(inputEl.value ?? '').trim() !== '';
    inputEl.classList.toggle('filled', hasValue);
  }

  function refreshRowFilledState(studentId) {
    const row = document.querySelector(`.student-row[data-student-id="${studentId}"]`);
    if (!row) return;
    setFilledState(row.querySelector('input.score-input'));
    setFilledState(row.querySelector('input.comment-input'));
  }

  function reinitTooltips(rootEl) {
    (rootEl || document).querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      const inst = bootstrap.Tooltip.getInstance(el);
      if (inst) inst.dispose();
      new bootstrap.Tooltip(el);
    });
  }

  function setTooltip(el, titleText) {
    if (!el) return;
    const inst = bootstrap.Tooltip.getInstance(el);
    if (inst) inst.dispose();

    if (titleText) {
      el.setAttribute('data-bs-toggle', 'tooltip');
      el.setAttribute('data-bs-placement', 'top');
      el.setAttribute('title', titleText);
    } else {
      el.removeAttribute('data-bs-toggle');
      el.removeAttribute('data-bs-placement');
      el.removeAttribute('title');
    }
  }

  function updateRowTimestamps(studentId, data) {
    const row = document.querySelector(`.student-row[data-student-id="${studentId}"]`);
    if (!row || !data) return;

    const scoreInput = row.querySelector('input.score-input');
    const commentInput = row.querySelector('input.comment-input');

    setTooltip(scoreInput, data.score_updated_at ? `–û—Ü–µ–Ω–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: ${formatTs(data.score_updated_at)}` : '');
    setTooltip(commentInput, data.comment_updated_at ? `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑–º–µ–Ω—ë–Ω: ${formatTs(data.comment_updated_at)}` : '');

    refreshRowFilledState(studentId);
    reinitTooltips(row);
  }

  function setGlobalIndicator(state, text) {
    const el = document.getElementById('globalSaveIndicator');
    el.classList.remove('saving','saved','error');
    if (state) el.classList.add(state);
    el.textContent = text || '‚Äî';
  }

  function selectPractice(el) {
    document.querySelectorAll('.practice-chip').forEach(x => x.classList.remove('active'));
    el.classList.add('active');

    activePracticeId = Number(el.dataset.id);
    activePracticeMin = Number(el.dataset.min);
    activePracticeMax = Number(el.dataset.max);
    activePracticeStartDate = normalizeIsoDate(el.dataset.start);
    activePracticeEndDate = normalizeIsoDate(el.dataset.end);

    setGlobalIndicator(null, getPracticeIndicatorText());
    reloadGrades();
  }

  function reloadGrades() {
    const area = document.getElementById('studentsArea');
    if (!activePracticeId) {
      area.innerHTML = '<div class="text-center text-muted mt-5">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</div>';
      return;
    }

    area.innerHTML = '<div class="text-center text-muted mt-5">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';

    fetch(`/api/practice/${activePracticeId}/group/${GROUP_ID}/grades`)
      .then(r => r.json())
      .then(d => {
        if (!d.success) { area.innerHTML = '<div class="text-center text-danger mt-5">–û—à–∏–±–∫–∞</div>'; return; }

        if (d.practice) {
          activePracticeMin = Number(d.practice.min_score ?? activePracticeMin);
          activePracticeMax = Number(d.practice.max_score ?? activePracticeMax);
          activePracticeStartDate = normalizeIsoDate(d.practice.start_date);
          activePracticeEndDate = normalizeIsoDate(d.practice.end_date);

          const activeChip = document.querySelector(`.practice-chip[data-id="${activePracticeId}"]`);
          if (activeChip) {
            activeChip.dataset.start = activePracticeStartDate || '';
            activeChip.dataset.end = activePracticeEndDate || '';
            renderChipInterval(activeChip, activePracticeStartDate, activePracticeEndDate);
          }
        }

        const rows = d.rows || [];
        if (!rows.length) {
          area.innerHTML = '<div class="text-center text-muted mt-5">–í –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div>';
          setGlobalIndicator(null, getPracticeIndicatorText());
          return;
        }

        const ul = document.createElement('ul');
        ul.className = 'list-group list-group-flush';
        ul.id = 'studentsUl';

        rows.forEach((r, idx) => {
          const li = document.createElement('li');
          li.className = 'list-group-item student-row';
          li.dataset.fio = (r.fio || '').toLowerCase();
          li.dataset.studentId = r.student_id;

          const top = document.createElement('div');
          top.className = 'd-flex justify-content-between align-items-center';

          const left = document.createElement('div');
          left.className = 'd-flex align-items-center gap-2';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = 'form-check-input';
          cb.dataset.sid = r.student_id;

          const name = document.createElement('div');
          name.className = 'fw-semibold student-name';
          name.textContent = `${idx + 1}. ${r.fio}`;
          name.title = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É';
          name.addEventListener('click', () => openStudentStats(r.student_id, r.fio));

          left.appendChild(cb);
          left.appendChild(name);

          const right = document.createElement('div');
          right.className = 'd-flex gap-2 align-items-center';

          const score = document.createElement('input');
          score.type = 'number';
          score.step = '0.5';
          score.min = String(activePracticeMin);
          score.max = String(activePracticeMax);
          score.className = 'form-control form-control-sm score-input';
          score.style.width = '120px';
          score.placeholder = '–ë–∞–ª–ª';
          score.value = (r.score === null || r.score === undefined) ? '' : r.score;

          if (r.score_updated_at) {
            score.setAttribute('data-bs-toggle', 'tooltip');
            score.setAttribute('data-bs-placement', 'top');
            score.title = `–û—Ü–µ–Ω–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: ${formatTs(r.score_updated_at)}`;
          }

          const comment = document.createElement('input');
          comment.type = 'text';
          comment.className = 'form-control form-control-sm comment-input';
          comment.style.width = '320px';
          comment.placeholder = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
          comment.value = r.comment || '';

          if (r.comment_updated_at) {
            comment.setAttribute('data-bs-toggle', 'tooltip');
            comment.setAttribute('data-bs-placement', 'top');
            comment.title = `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑–º–µ–Ω—ë–Ω: ${formatTs(r.comment_updated_at)}`;
          }

          setFilledState(score);
          setFilledState(comment);

          score.addEventListener('input', () => {
            setFilledState(score);
            queueAutoSave(r.student_id, score.value, comment.value);
          });
          comment.addEventListener('input', () => {
            setFilledState(comment);
            queueAutoSave(r.student_id, score.value, comment.value);
          });
          score.addEventListener('blur', () => {
            setFilledState(score);
            flushAutoSave(r.student_id, score.value, comment.value);
          });
          comment.addEventListener('blur', () => {
            setFilledState(comment);
            flushAutoSave(r.student_id, score.value, comment.value);
          });

          right.appendChild(score);
          right.appendChild(comment);

          top.appendChild(left);
          top.appendChild(right);

          li.appendChild(top);
          ul.appendChild(li);
        });

        area.innerHTML = '';
        area.appendChild(ul);
        reinitTooltips(area);

        document.getElementById('studentSearch').value = '';
        setGlobalIndicator(null, getPracticeIndicatorText());
      })
      .catch(() => area.innerHTML = '<div class="text-center text-danger mt-5">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>');
  }

  function queueAutoSave(studentId, score, comment) {
    if (!activePracticeId) return;

    const key = Number(studentId);
    const payloadKey = `${String(score ?? '')}|${String(comment ?? '')}`;

    if (lastPayload.get(key) === payloadKey) return;

    if (saveTimers.has(key)) clearTimeout(saveTimers.get(key));
    setGlobalIndicator('saving', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶');

    const t = setTimeout(() => {
      flushAutoSave(key, score, comment);
    }, 600);

    saveTimers.set(key, t);
  }

  function flushAutoSave(studentId, score, comment) {
    if (!activePracticeId) return;

    const key = Number(studentId);
    if (saveTimers.has(key)) {
      clearTimeout(saveTimers.get(key));
      saveTimers.delete(key);
    }

    const payloadKey = `${String(score ?? '')}|${String(comment ?? '')}`;
    if (lastPayload.get(key) === payloadKey) return;

    fetch(`/api/practice/${activePracticeId}/grade_one`, {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF_TOKEN},
      body: JSON.stringify({student_id: key, score: score, comment: comment})
    })
    .then(r => r.json())
    .then(d => {
      if (!d.success) {
        setGlobalIndicator('error', d.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        return;
      }
      lastPayload.set(key, payloadKey);
      updateRowTimestamps(key, d);
      setGlobalIndicator('saved', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      setTimeout(() => {
        const el = document.getElementById('globalSaveIndicator');
        if (el.classList.contains('saved')) setGlobalIndicator(null, getPracticeIndicatorText());
      }, 900);
    })
    .catch(() => setGlobalIndicator('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
  }

  function applyBulkAllGroup() {
    if (!activePracticeId) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ'); return; }

    const score = document.getElementById('bulkScore').value;
    const comment = document.getElementById('bulkComment').value;

    if (!confirm('–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã?')) return;

    setGlobalIndicator('saving', '–ü—Ä–∏–º–µ–Ω—è–µ–º‚Ä¶');

    fetch(`/api/practice/${activePracticeId}/grade_bulk_group`, {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF_TOKEN},
      body: JSON.stringify({group_id: GROUP_ID, score: score, comment: comment})
    })
    .then(r => r.json())
    .then(d => {
      if (!d.success) { setGlobalIndicator('error', d.error || '–û—à–∏–±–∫–∞'); return; }
      reloadGrades();
      setGlobalIndicator('saved', '–ü—Ä–∏–º–µ–Ω–µ–Ω–æ');
      setTimeout(() => setGlobalIndicator(null, getPracticeIndicatorText()), 900);
    })
    .catch(() => setGlobalIndicator('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
  }

  function applyBulkSelected() {
    if (!activePracticeId) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ'); return; }

    const score = document.getElementById('bulkScore').value;
    const comment = document.getElementById('bulkComment').value;

    const ids = [];
    document.querySelectorAll('#studentsArea input.form-check-input[type="checkbox"]').forEach(cb => {
      if (cb.checked) ids.push(parseInt(cb.dataset.sid, 10));
    });

    if (!ids.length) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥–∞–ª–æ—á–∫–∞–º–∏'); return; }

    setGlobalIndicator('saving', '–ü—Ä–∏–º–µ–Ω—è–µ–º‚Ä¶');

    fetch(`/api/practice/${activePracticeId}/grade_bulk_students`, {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF_TOKEN},
      body: JSON.stringify({student_ids: ids, score: score, comment: comment})
    })
    .then(r => r.json())
    .then(d => {
      if (!d.success) { setGlobalIndicator('error', d.error || '–û—à–∏–±–∫–∞'); return; }
      reloadGrades();
      setGlobalIndicator('saved', '–ü—Ä–∏–º–µ–Ω–µ–Ω–æ');
      setTimeout(() => setGlobalIndicator(null, getPracticeIndicatorText()), 900);
    })
    .catch(() => setGlobalIndicator('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
  }

  function getIntervalModal() {
    const modalEl = document.getElementById('practiceIntervalModal');
    if (!modalEl) return null;
    if (!intervalModalInstance) {
      intervalModalInstance = new bootstrap.Modal(modalEl);
    }
    return intervalModalInstance;
  }

  function clearIntervalInputs() {
    const startEl = document.getElementById('intervalStartDate');
    const endEl = document.getElementById('intervalEndDate');
    if (startEl) startEl.value = '';
    if (endEl) endEl.value = '';
  }

  function openIntervalModal() {
    if (!activePracticeId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');
      return;
    }
    const startEl = document.getElementById('intervalStartDate');
    const endEl = document.getElementById('intervalEndDate');
    if (startEl) startEl.value = activePracticeStartDate || '';
    if (endEl) endEl.value = activePracticeEndDate || '';

    const modal = getIntervalModal();
    if (modal) modal.show();
  }

  function saveGroupInterval() {
    if (!activePracticeId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');
      return;
    }

    const startEl = document.getElementById('intervalStartDate');
    const endEl = document.getElementById('intervalEndDate');
    const start_date = normalizeIsoDate(startEl ? startEl.value : '');
    const end_date = normalizeIsoDate(endEl ? endEl.value : '');

    if ((start_date && !end_date) || (!start_date && end_date)) {
      alert('–£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –æ–±–µ –ø—É—Å—Ç—ã–º–∏');
      return;
    }

    setGlobalIndicator('saving', '–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª‚Ä¶');

    fetch(`/api/practice/${activePracticeId}/group/${GROUP_ID}/interval`, {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF_TOKEN},
      body: JSON.stringify({start_date, end_date})
    })
      .then(r => r.json())
      .then(d => {
        if (!d.success) {
          setGlobalIndicator('error', d.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          return;
        }

        const interval = d.interval || {};
        activePracticeStartDate = normalizeIsoDate(interval.start_date);
        activePracticeEndDate = normalizeIsoDate(interval.end_date);

        const activeChip = document.querySelector(`.practice-chip[data-id="${activePracticeId}"]`);
        if (activeChip) {
          activeChip.dataset.start = activePracticeStartDate || '';
          activeChip.dataset.end = activePracticeEndDate || '';
          renderChipInterval(activeChip, activePracticeStartDate, activePracticeEndDate);
        }

        const modal = getIntervalModal();
        if (modal) modal.hide();

        setGlobalIndicator('saved', '–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª—ë–Ω');
        setTimeout(() => {
          const el = document.getElementById('globalSaveIndicator');
          if (el.classList.contains('saved')) setGlobalIndicator(null, getPracticeIndicatorText());
        }, 900);
      })
      .catch(() => setGlobalIndicator('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
  }

  function filterStudents() {
    const q = (document.getElementById('studentSearch').value || '').trim().toLowerCase();
    document.querySelectorAll('.student-row').forEach(row => {
      const fio = row.dataset.fio || '';
      row.style.display = fio.includes(q) ? '' : 'none';
    });
  }

  function openStudentStats(studentId, fio) {
    const title = document.getElementById('statsTitle');
    const body = document.getElementById('statsBody');
    title.textContent = fio || '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞';
    body.innerHTML = '<div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';

    fetch(`/api/course/${COURSE_ID}/student/${studentId}/stats`, {
      headers: {'X-CSRFToken': CSRF_TOKEN}
    })
      .then(r => r.json())
      .then(d => {
        if (!d.success) {
          body.innerHTML = `<div class="text-danger">${d.error || '–û—à–∏–±–∫–∞'}</div>`;
          return;
        }

        const done = Number(d.completed_practices || 0);
        const total = Number(d.total_practices || 0);
        const missing = (d.missing_practices !== undefined && d.missing_practices !== null)
          ? Number(d.missing_practices)
          : Math.max(0, total - done);
        const p = total ? Math.round((done * 100) / total) : 0;

        const lastScore = d.last_score_updated_at ? formatTs(d.last_score_updated_at) : '‚Äî';
        const lastComment = d.last_comment_updated_at ? formatTs(d.last_comment_updated_at) : '‚Äî';

        body.innerHTML = `
          <div class="d-flex align-items-start gap-3">
            <div class="donut" style="--p: ${p};" title="–°–¥–∞–Ω–æ: ${done}. –ù–µ —Å–¥–∞–Ω–æ: ${missing}">
              <div class="donut-text">${p}%</div>
            </div>
            <div class="flex-grow-1">
              <div class="mb-2"><span class="fw-semibold">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø—Ä–∞–∫—Ç–∏–∫:</span> ${done} / ${total}</div>
              <div class="mb-2"><span class="fw-semibold">–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:</span> ${missing}</div>
              <div class="mb-2"><span class="fw-semibold">–ë–∞–ª–ª—ã:</span> ${d.total_score} / ${d.max_possible}</div>
              <div class="mt-3 small-muted">
                <div><i class="bi bi-clock-history me-1"></i>–û—Ü–µ–Ω–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: <span class="fw-semibold">${lastScore}</span></div>
                <div><i class="bi bi-chat-left-text me-1"></i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑–º–µ–Ω—ë–Ω: <span class="fw-semibold">${lastComment}</span></div>
              </div>
              <div class="text-muted small mt-2">* ‚Äú–í—ã–ø–æ–ª–Ω–µ–Ω–æ‚Äù —Å—á–∏—Ç–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –±–∞–ª–ª –≤—ã—Å—Ç–∞–≤–ª–µ–Ω.</div>
            </div>
          </div>
        `;
      })
      .catch(() => { body.innerHTML = `<div class="text-danger">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>`; });

    new bootstrap.Modal(document.getElementById('studentStatsModal')).show();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const firstChip = document.querySelector('#practiceChips .practice-chip');
    if (firstChip) {
      selectPractice(firstChip);
    }
  });
</script>

</body>
</html>
