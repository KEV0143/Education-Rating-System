<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{{ course.title }} ‚Äî –ó–∞–¥–∞–Ω–∏—è –∏ –±–∞–ª–ª—ã</title>

  <script>
    (() => {
      const saved = localStorage.getItem('rs-theme');
      const theme = (saved === 'dark' || saved === 'light') ? saved : 'light';
      document.documentElement.setAttribute('data-bs-theme', theme);
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <link rel="icon" href="{{ url_for('static', filename='iconkev.ico') }}" type="image/x-icon">
  <link rel="shortcut icon" href="{{ url_for('static', filename='iconkev.ico') }}" type="image/x-icon">

  <style>
    :root{
      --rs-page-bg: #f8f9fa;
      --rs-text: #333;
      --rs-card-bg: #ffffff;
      --rs-border: #eee;
      --rs-soft-border: #dee2e6;
      --rs-shadow: rgba(0,0,0,0.03);
      --rs-hover-bg: #f1f3f5;
      --rs-muted: #6c757d;
    }
    :root[data-bs-theme="dark"]{
      --rs-page-bg: #0f1216;
      --rs-text: #e9ecef;
      --rs-card-bg: #151a21;
      --rs-border: rgba(255,255,255,0.08);
      --rs-soft-border: rgba(255,255,255,0.14);
      --rs-shadow: rgba(0,0,0,0.35);
      --rs-hover-bg: rgba(255,255,255,0.06);
      --rs-muted: rgba(255,255,255,0.65);
    }

    body { background-color: var(--rs-page-bg); color: var(--rs-text); font-family: 'Segoe UI', system-ui, sans-serif; }
    .panel-card { border-radius: 12px; box-shadow: 0 2px 5px var(--rs-shadow); border: 1px solid var(--rs-border); background: var(--rs-card-bg); }

    .list-item {
      cursor: pointer; padding: 10px 12px; border-radius: 8px; transition: .15s;
      border: 1px solid transparent;
    }
    .list-item:hover { background: var(--rs-hover-bg); }
    .list-item.active {
      background: rgba(99,102,241,0.12);
      border-color: rgba(99,102,241,0.35);
      color: var(--rs-text);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.12);
    }
    .list-item.active .small-muted { color: var(--rs-muted); }

    .small-muted { font-size: .85rem; color: var(--rs-muted); }
    .badge-soft {
      background: rgba(99,102,241,0.12);
      color: #4f46e5;
      border: 1px solid rgba(99,102,241,0.25);
      padding: 4px 8px; border-radius: 8px; font-size: .8rem; font-weight: 600;
      display: inline-block;
    }

    :root[data-bs-theme="dark"] .badge-soft{ color: #c7d2fe; }
    :root[data-bs-theme="dark"] .bg-light{ background-color: var(--rs-card-bg) !important; }
    :root[data-bs-theme="dark"] .bg-white{ background-color: var(--rs-card-bg) !important; }
    :root[data-bs-theme="dark"] .text-dark{ color: var(--rs-text) !important; }
  </style>
</head>
<body>
{% from "partials/settings.html" import settings_button, settings_modal %}

<div class="container py-5" id="page" data-course-id="{{ course.id }}">
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <a href="{{ url_for('course_detail', course_id=course.id) }}" class="btn btn-outline-secondary btn-sm mb-2">
        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É
      </a>
      <h2 class="m-0 fw-bold">–ó–∞–¥–∞–Ω–∏—è –∏ –±–∞–ª–ª—ã</h2>
      <div class="text-muted small mt-1">
        <span class="fw-semibold">{{ course.title }}</span> ¬∑ {{ course.year }} ¬∑ {{ course.semester }} —Å–µ–º–µ—Å—Ç—Ä
      </div>
    </div>

    <div class="ms-3">
      {{ settings_button() }}
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-5">
      <div class="panel-card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-bold">–ó–∞–¥–∞–Ω–∏—è (–ø—Ä–∞–∫—Ç–∏–∫–∏)</div>
          <span class="badge bg-secondary" id="practiceCount">{{ practices|length }}</span>
        </div>

        <div class="mb-3">
          <div class="small-muted mb-1">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</div>
          <input class="form-control mb-2" id="pTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–∞–∫—Ç–∏–∫–∞ 1 ‚Äî –õ–†">
          <div class="row g-2">
            <div class="col">
              <input class="form-control" id="pMin" type="number" step="0.5" placeholder="–ú–∏–Ω" value="0">
            </div>
            <div class="col">
              <input class="form-control" id="pMax" type="number" step="0.5" placeholder="–ú–∞–∫—Å" value="10">
            </div>
          </div>

          <div class="row g-2 mt-1">
            <div class="col">
              <input class="form-control" id="pStartDate" type="date">
            </div>
            <div class="col">
              <input class="form-control" id="pEndDate" type="date">
            </div>
          </div>
          <div class="small-muted mt-1">–°—Ä–æ–∫–∏ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã. –ï—Å–ª–∏ –∑–∞–¥–∞—Ç—å, –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∫–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º.</div>

          <button class="btn btn-primary w-100 mt-2" type="button" onclick="createPractice()">
            <i class="bi bi-plus-circle me-1"></i> –î–æ–±–∞–≤–∏—Ç—å
          </button>

          <div class="small-muted mt-2">
            –≠—Ç–∏ –∑–∞–¥–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤–æ –≤—Å–µ—Ö –≥—Ä—É–ø–ø–∞—Ö –∫—É—Ä—Å–∞.
          </div>
        </div>

        <div id="practiceList">
          {% if practices %}
            {% for p in practices %}
              <div class="list-item practice-item"
                   data-id="{{ p.id }}"
                   data-title="{{ p.title }}"
                   data-min="{{ p.min_score }}"
                   data-max="{{ p.max_score }}"
                   data-start="{{ p.start_date.isoformat() if p.start_date else '' }}"
                   data-end="{{ p.end_date.isoformat() if p.end_date else '' }}"
                   onclick="selectPractice(this)">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="fw-semibold text-truncate">{{ p.title }}</div>
                  <span class="badge-soft ms-2">{{ p.min_score }}‚Äî{{ p.max_score }}</span>
                </div>
                <div class="small-muted practice-interval">
                  {% if p.start_date and p.end_date %}
                    –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {{ p.start_date.strftime('%d.%m.%Y') }} ‚Äî {{ p.end_date.strftime('%d.%m.%Y') }}
                  {% elif p.start_date %}
                    –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: —Å {{ p.start_date.strftime('%d.%m.%Y') }}
                  {% elif p.end_date %}
                    –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –¥–æ {{ p.end_date.strftime('%d.%m.%Y') }}
                  {% else %}
                    –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –Ω–µ –∑–∞–¥–∞–Ω—ã
                  {% endif %}
                </div>
                <div class="small-muted">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="panel-card p-3">
        <div class="fw-bold mb-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
        <div class="text-muted small mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ —Å–ª–µ–≤–∞</div>

        <div id="editBlock" style="display:none;">
          <div class="mb-2">
            <label class="small-muted">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input class="form-control" id="eTitle">
          </div>

          <div class="row g-2 mb-3">
            <div class="col">
              <label class="small-muted">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª</label>
              <input class="form-control" id="eMin" type="number" step="0.5">
            </div>
            <div class="col">
              <label class="small-muted">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª</label>
              <input class="form-control" id="eMax" type="number" step="0.5">
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col">
              <label class="small-muted">–ù–∞—á–∞–ª–æ –ø—Ä–∞–∫—Ç–∏–∫–∏</label>
              <input class="form-control" id="eStartDate" type="date">
            </div>
            <div class="col">
              <label class="small-muted">–ö–æ–Ω–µ—Ü –ø—Ä–∞–∫—Ç–∏–∫–∏</label>
              <input class="form-control" id="eEndDate" type="date">
            </div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="button" onclick="updatePractice()">
              <i class="bi bi-save me-1"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button class="btn btn-outline-danger" type="button" onclick="deletePractice()">
              <i class="bi bi-trash me-1"></i> –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>

          <div class="small-muted mt-3">
            –û—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ ‚Äî –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã –∫—É—Ä—Å–∞.
          </div>
        </div>

        <div id="hintBlock" class="text-center text-muted py-5">
          <i class="bi bi-clipboard2-check display-6 opacity-25"></i>
          <div class="mt-2">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
        </div>
      </div>

      <div class="panel-card p-3 mt-3">
        <div class="fw-bold mb-2">–ì—Ä—É–ø–ø—ã –∫—É—Ä—Å–∞</div>
        {% if groups %}
          <div class="small-muted mb-2">–û—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã:</div>
          <div class="d-flex flex-wrap gap-2">
            {% for g in groups %}
              <a class="badge bg-primary text-decoration-none"
                 href="{{ url_for('course_group', course_id=course.id, group_id=g.id) }}">
                {{ g.name }}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">–£ –∫—É—Ä—Å–∞ –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{{ settings_modal(app_version) }}
{% if update_available and update_url %}
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ {{ update_remote_version.lstrip('vV') }}üéâ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>
        <div class="text-muted small">–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: <strong>{{ app_version.lstrip('vV') }}</strong></div>
        <div class="text-muted small">–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: <strong>{{ update_remote_version.lstrip('vV') }}</strong></div>

        {% if update_notes %}
        <div class="mt-3">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="toggleNotesBtn" aria-expanded="false">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <div class="mt-2 border rounded p-2 bg-light" id="updateNotes" style="display:none; white-space: pre-wrap; max-height: 260px; overflow:auto;">{{ update_notes }}</div>
        </div>
        {% endif %}
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-primary" type="button" id="viewChangesBtn" data-release-url="{{ update_release_url|default('', true) }}" {% if not update_release_url %}disabled{% endif %}>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <div class="d-flex gap-2 ms-auto">
          <button class="btn btn-outline-secondary" type="button" id="updateLaterBtn" data-bs-dismiss="modal">–ü–æ–∑–∂–µ</button>
          <button class="btn btn-primary" type="button" id="downloadUpdateBtn" data-source-url="{{ (update_source_url or update_url)|default('', true) }}" data-exe-url="{{ update_exe_url|default('', true) }}">–°–∫–∞—á–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="updateDownloadTypeModal" tabindex="-1" aria-labelledby="updateDownloadTypeModalLabel" aria-hidden="true" style="--bs-backdrop-opacity: .94;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateDownloadTypeModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted small mb-3">–î–æ—Å—Ç—É–ø–Ω—ã –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</div>
        <div class="d-grid gap-2">
          <button class="btn btn-outline-secondary text-start" type="button" id="downloadSourceBtn" data-source-url="{{ (update_source_url or update_url)|default('', true) }}">
            –ê—Ä—Ö–∏–≤ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (Open Source, .zip)
          </button>
          <button class="btn btn-outline-primary text-start" type="button" id="downloadExeBtn" data-exe-url="{{ update_exe_url|default('', true) }}" {% if not update_exe_url %}disabled{% endif %}>
            –ì–æ—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è Windows (.exe)
          </button>
        </div>
        {% if not update_exe_url %}
        <div class="small text-muted mt-3">–î–ª—è —ç—Ç–æ–≥–æ —Ä–µ–ª–∏–∑–∞ —Ñ–∞–π–ª .exe –ø–æ–∫–∞ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% if update_available and update_url %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('updateModal');
    const updateModal = modalEl ? new bootstrap.Modal(modalEl) : null;
    if (updateModal) {
      updateModal.show();
    }

    const viewChangesBtn = document.getElementById('viewChangesBtn');
    if (viewChangesBtn) {
      viewChangesBtn.addEventListener('click', () => {
        const rel = viewChangesBtn.dataset.releaseUrl;
        if (rel) window.open(rel, '_blank');
      });
    }

    const btn = document.getElementById('downloadUpdateBtn');
    const downloadTypeModalEl = document.getElementById('updateDownloadTypeModal');
    const downloadTypeModal = downloadTypeModalEl ? new bootstrap.Modal(downloadTypeModalEl) : null;
    if (btn) {
      btn.addEventListener('click', () => {
        if (downloadTypeModal) {
          if (updateModal) updateModal.hide();
          setTimeout(() => downloadTypeModal.show(), 180);
          return;
        }
        const fallbackUrl = btn.dataset.sourceUrl || btn.dataset.exeUrl;
        if (fallbackUrl) window.open(fallbackUrl, '_blank');
      });
    }

    const sourceBtn = document.getElementById('downloadSourceBtn');
    if (sourceBtn) {
      sourceBtn.addEventListener('click', () => {
        const sourceUrl = sourceBtn.dataset.sourceUrl;
        if (sourceUrl) window.open(sourceUrl, '_blank');
      });
    }

    const exeBtn = document.getElementById('downloadExeBtn');
    if (exeBtn) {
      exeBtn.addEventListener('click', () => {
        const exeUrl = exeBtn.dataset.exeUrl;
        if (exeUrl) window.open(exeUrl, '_blank');
      });
    }

    const laterBtn = document.getElementById('updateLaterBtn');
    if (laterBtn) {
      laterBtn.addEventListener('click', () => {
        const tokenMeta = document.querySelector('meta[name="csrf-token"]');
        const token = tokenMeta ? tokenMeta.getAttribute('content') : '';
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['X-CSRFToken'] = token;
        fetch('/api/update/remind_later', {
          method: 'POST',
          headers,
          body: '{}'
        }).catch(() => {});
      });
    }

    const notesBtn = document.getElementById('toggleNotesBtn');
    const notes = document.getElementById('updateNotes');
    if (notesBtn && notes) {
      notesBtn.addEventListener('click', () => {
        const isHidden = notes.style.display === 'none' || !notes.style.display;
        notes.style.display = isHidden ? 'block' : 'none';
        notesBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        notesBtn.textContent = isHidden ? '–°–∫—Ä—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      });
    }
  });
</script>
{% endif %}
<script>
  const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const COURSE_ID = Number(document.getElementById('page').dataset.courseId);
  let activePracticeId = null;

  function normalizedDateValue(v) {
    const s = String(v || '').trim();
    return s || null;
  }

  function formatDateOnly(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return String(iso);
    return d.toLocaleDateString('ru-RU', {
      year: 'numeric', month: '2-digit', day: '2-digit'
    });
  }

  function intervalDisplayText(startIso, endIso) {
    const start = normalizedDateValue(startIso);
    const end = normalizedDateValue(endIso);
    if (!start && !end) return '–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –Ω–µ –∑–∞–¥–∞–Ω—ã';
    if (start && end) return `–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${formatDateOnly(start)} ‚Äî ${formatDateOnly(end)}`;
    if (start) return `–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: —Å ${formatDateOnly(start)}`;
    return `–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –¥–æ ${formatDateOnly(end)}`;
  }

  function selectPractice(el) {
    document.querySelectorAll('.practice-item').forEach(x => x.classList.remove('active'));
    el.classList.add('active');

    activePracticeId = Number(el.dataset.id);

    document.getElementById('hintBlock').style.display = 'none';
    document.getElementById('editBlock').style.display = 'block';

    document.getElementById('eTitle').value = el.dataset.title || '';
    document.getElementById('eMin').value = el.dataset.min || '0';
    document.getElementById('eMax').value = el.dataset.max || '10';
    document.getElementById('eStartDate').value = el.dataset.start || '';
    document.getElementById('eEndDate').value = el.dataset.end || '';
  }

  function createPractice() {
    const title = (document.getElementById('pTitle').value || '').trim();
    const min_score = document.getElementById('pMin').value;
    const max_score = document.getElementById('pMax').value;
    const start_date = normalizedDateValue(document.getElementById('pStartDate').value);
    const end_date = normalizedDateValue(document.getElementById('pEndDate').value);

    if (!title) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è'); return; }
    if ((start_date && !end_date) || (!start_date && end_date)) {
      alert('–£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –æ–±–µ –ø—É—Å—Ç—ã–º–∏');
      return;
    }

    fetch(`/api/course/${COURSE_ID}/practice_create`, {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF_TOKEN},
      body: JSON.stringify({title, min_score, max_score, start_date, end_date})
    })
    .then(r => r.json())
    .then(d => {
      if (!d.success) { alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å'); return; }

      document.getElementById('pTitle').value = '';
      const p = d.practice;

      const list = document.getElementById('practiceList');
      const empty = list.querySelector('.text-muted.text-center.py-4');
      if (empty) list.innerHTML = '';
      const item = document.createElement('div');
      item.className = 'list-item practice-item';
      item.dataset.id = p.id;
      item.dataset.title = p.title;
      item.dataset.min = p.min_score;
      item.dataset.max = p.max_score;
      item.dataset.start = p.start_date || '';
      item.dataset.end = p.end_date || '';

      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div class="fw-semibold text-truncate"></div>
          <span class="badge-soft ms-2"></span>
        </div>
        <div class="small-muted practice-interval"></div>
        <div class="small-muted">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
      `;
      item.querySelector('.fw-semibold').textContent = p.title;
      item.querySelector('.badge-soft').textContent = `${p.min_score}‚Äî${p.max_score}`;
      item.querySelector('.practice-interval').textContent = intervalDisplayText(p.start_date, p.end_date);

      item.addEventListener('click', () => selectPractice(item));
      list.appendChild(item);

      const cnt = document.getElementById('practiceCount');
      cnt.innerText = String(parseInt(cnt.innerText || '0', 10) + 1);

      selectPractice(item);
    })
    .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
  }

  function updatePractice() {
    if (!activePracticeId) return;

    const title = (document.getElementById('eTitle').value || '').trim();
    const min_score = document.getElementById('eMin').value;
    const max_score = document.getElementById('eMax').value;
    const start_date = normalizedDateValue(document.getElementById('eStartDate').value);
    const end_date = normalizedDateValue(document.getElementById('eEndDate').value);

    if (!title) { alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'); return; }
    if ((start_date && !end_date) || (!start_date && end_date)) {
      alert('–£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –æ–±–µ –ø—É—Å—Ç—ã–º–∏');
      return;
    }

    fetch(`/api/practice/${activePracticeId}/update`, {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF_TOKEN},
      body: JSON.stringify({title, min_score, max_score, start_date, end_date})
    })
    .then(r => r.json())
    .then(d => {
      if (!d.success) { alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'); return; }

      const el = document.querySelector(`.practice-item[data-id="${activePracticeId}"]`);
      if (el) {
        el.dataset.title = d.practice.title;
        el.dataset.min = d.practice.min_score;
        el.dataset.max = d.practice.max_score;
        el.dataset.start = d.practice.start_date || '';
        el.dataset.end = d.practice.end_date || '';

        el.querySelector('.fw-semibold').textContent = d.practice.title;
        el.querySelector('.badge-soft').textContent = `${d.practice.min_score}‚Äî${d.practice.max_score}`;
        const intervalEl = el.querySelector('.practice-interval');
        if (intervalEl) intervalEl.textContent = intervalDisplayText(d.practice.start_date, d.practice.end_date);
      }
    })
    .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
  }

  function deletePractice() {
    if (!activePracticeId) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ? –û—Ü–µ–Ω–∫–∏ –ø–æ –Ω–µ–º—É —Ç–æ–∂–µ —É–¥–∞–ª—è—Ç—Å—è.')) return;

    fetch(`/api/practice/${activePracticeId}/delete`, {
      method: 'POST',
      headers: {'X-CSRFToken': CSRF_TOKEN}
    })
    .then(r => r.json())
    .then(d => {
      if (!d.success) { alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'); return; }

      const el = document.querySelector(`.practice-item[data-id="${activePracticeId}"]`);
      if (el) el.remove();

      const cnt = document.getElementById('practiceCount');
      cnt.innerText = String(Math.max(0, parseInt(cnt.innerText || '1', 10) - 1));

      activePracticeId = null;
      document.getElementById('editBlock').style.display = 'none';
      document.getElementById('hintBlock').style.display = 'block';
    })
    .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
  }
</script>

</body>
</html>
